<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGAN CC's - Loja</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #globalLoader{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;visibility:hidden;z-index:9999}.spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid #10b981;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}#notifications{position:fixed;top:1rem;right:1rem;max-width:300px;z-index:10000}.notification{background:#1f2937;color:white;padding:1rem;border-radius:6px;margin-bottom:0.5rem;box-shadow:0 2px 4px rgba(0,0,0,0.2);display:flex;justify-content:space-between}.notification-error{background:#ef4444}.notification-success{background:#10b981}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center}.modal.show{display:flex}table{width:100%;border-collapse:collapse}th,td{padding:0.75rem;text-align:left;border-bottom:1px solid #4b5563}th{background:#1f2937;font-weight:600}.action-button{padding:0.5rem;border-radius:4px;background:#3b82f6;color:white}.action-button:hover{background:#2563eb}
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div id="globalLoader"><div class="spinner"></div></div>
    <div id="notifications"></div>
    <header class="bg-gray-800 p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-green-500">LOGAN CC's - Loja</h1>
        <div class="flex items-center space-x-4">
            <span id="userBalance" class="text-gray-300"></span>
            <button id="dashboardButton" class="text-gray-300 hover:text-green-500 hidden" aria-label="Ir para o Dashboard"><i class="fas fa-tachometer-alt mr-2"></i>Dashboard</button>
            <button id="logoutButton" class="text-gray-300 hover:text-red-500" aria-label="Sair"><i class="fas fa-sign-out-alt"></i>Sair</button>
        </div>
    </header>
    <main class="container mx-auto p-6">
        <div class="bg-gray-800 p-4 rounded-lg mb-6">
            <div class="flex flex-wrap gap-4 mb-4">
                <div>
                    <label for="searchCard" class="block text-sm font-medium">Buscar Número</label>
                    <input id="searchCard" class="mt-1 p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="ex.: 1234" pattern="\d*" aria-describedby="searchCardError">
                    <p id="searchCardError" class="text-red-500 text-sm hidden mt-1"></p>
                </div>
                <div>
                    <label for="filterBandeira" class="block text-sm font-medium">Bandeira</label>
                    <select id="filterBandeira" class="mt-1 p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500">
                        <option value="">Todas</option>
                        <option value="Visa">Visa</option>
                        <option value="Mastercard">Mastercard</option>
                        <option value="Amex">Amex</option>
                        <option value="Elo">Elo</option>
                        <option value="Hipercard">Hipercard</option>
                        <option value="Diners Club">Diners Club</option>
                    </select>
                </div>
                <div>
                    <label for="filterBanco" class="block text-sm font-medium">Banco</label>
                    <select id="filterBanco" class="mt-1 p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500">
                        <option value="">Todos</option>
                        <option value="Nubank">Nubank</option>
                        <option value="Itaú">Itaú</option>
                        <option value="Bradesco">Bradesco</option>
                        <option value="Santander">Santander</option>
                        <option value="Banco do Brasil">Banco do Brasil</option>
                        <option value="Caixa Econômica Federal">Caixa Econômica Federal</option>
                        <option value="Sicredi">Sicredi</option>
                        <option value="Sicoob">Sicoob</option>
                    </select>
                </div>
                <div>
                    <label for="filterNivel" class="block text-sm font-medium">Nível</label>
                    <select id="filterNivel" class="mt-1 p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500">
                        <option value="">Todos</option>
                        <option value="Classic">Classic</option>
                        <option value="Gold">Gold</option>
                        <option value="Platinum">Platinum</option>
                        <option value="Black">Black</option>
                    </select>
                </div>
            </div>
            <div id="cardList" class="overflow-x-auto">
                <table><thead><tr><th>Número</th><th>Bandeira</th><th>Banco</th><th>Nível</th><th>Preço</th><th>Ações</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </main>
    <div id="viewCardModal" class="modal" role="dialog" aria-labelledby="viewCardModalTitle">
        <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full">
            <h2 id="viewCardModalTitle" class="text-xl font-semibold mb-4"><i class="fas fa-credit-card mr-2"></i>Detalhes do Cartão</h2>
            <div class="space-y-2">
                <p><strong>Número:</strong> <span id="viewCardNumber"></span></p>
                <p><strong>CVV:</strong> <span id="viewCardCvv"></span></p>
                <p><strong>Validade:</strong> <span id="viewCardExpiry"></span></p>
                <p><strong>Nome:</strong> <span id="viewCardName"></span></p>
                <p><strong>CPF:</strong> <span id="viewCardCpf"></span></p>
                <p><strong>Bandeira:</strong> <span id="viewCardBandeira"></span></p>
                <p><strong>Banco:</strong> <span id="viewCardBanco"></span></p>
                <p><strong>Nível:</strong> <span id="viewCardNivel"></span></p>
                <p><strong>Preço:</strong> <span id="viewCardPrice"></span></p>
            </div>
            <p id="viewCardError" class="text-red-500 text-sm hidden mt-2"></p>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="cancelViewCardButton" class="py-2 px-4 bg-gray-600 text-white rounded hover:bg-gray-700" aria-label="Fechar"><i class="fas fa-times mr-2"></i>Fechar</button>
                <button id="buyCardButton" class="py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600 flex items-center" aria-busy="false">
                    <span>Comprar</span><svg id="buyCardSpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"/><path fill="currentColor" d="M4 12a8 8 0 018-8v8H4z" class="opacity-75"/></svg>
                </button>
            </div>
        </div>
    </div>
    <div id="debug" class="fixed bottom-4 left-4 bg-gray-900 text-white p-4 rounded-md max-w-xs text-xs overflow-y-auto max-h-40"></div>
    <script src="debug.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.9/purify.min.js" async></script>
    <script>
        const sanitizeInput = input => DOMPurify.sanitize(input, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
        const formatCurrency = value => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const formatCardNumber = num => num.replace(/(\d{4})(\d{4})(\d{4})(\d{4})/, '$1 $2 $3 $4');
        const formatCpf = cpf => cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        const showNotification = (msg, isError = false) => {
            const n = document.createElement('div');
            n.className = `notification ${isError ? 'notification-error' : 'notification-success'}`;
            n.innerHTML = `${sanitizeInput(msg)}<button class="ml-2 text-white hover:text-gray-300"><i class="fas fa-times"></i></button>`;
            document.getElementById('notifications').appendChild(n);
            n.querySelector('button').onclick = () => n.remove();
            setTimeout(() => n.remove(), 3000);
        };
        const toggleLoader = show => document.getElementById('globalLoader').style.visibility = show ? 'visible' : 'hidden';
        let cardsCache = [];
        document.addEventListener('DOMContentLoaded', async () => {
            const userId = localStorage.getItem('userId');
            const token = localStorage.getItem('token');
            if (!userId || !token) {
                window.location.href = 'index.html';
                return;
            }
            toggleLoader(true);
            try {
                const res = await fetch(`/api/users?userId=${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await res.json();
                if (res.status !== 200) throw new Error(user.error);
                document.getElementById('userBalance').textContent = `Saldo: ${formatCurrency(user.balance)}`;
                if (user.is_admin) document.getElementById('dashboardButton').classList.remove('hidden');
            } catch (err) {
                showNotification('Erro ao carregar usuário.', true);
                localStorage.clear();
                setTimeout(() => window.location.href = 'index.html', 1000);
                return;
            } finally {
                toggleLoader(false);
            }
            document.getElementById('logoutButton').onclick = () => {
                localStorage.clear();
                window.location.href = 'index.html';
            };
            document.getElementById('dashboardButton').onclick = () => window.location.href = 'dashboard.html';
            document.getElementById('searchCard').oninput = () => {
                const searchInput = document.getElementById('searchCard');
                const errorDiv = document.getElementById('searchCardError');
                if (searchInput.value && !/^\d*$/.test(searchInput.value)) {
                    errorDiv.textContent = 'Apenas dígitos são permitidos.';
                    errorDiv.classList.remove('hidden');
                } else {
                    errorDiv.classList.add('hidden');
                    filterCards();
                }
            };
            document.getElementById('filterBandeira').onchange = filterCards;
            document.getElementById('filterBanco').onchange = filterCards;
            document.getElementById('filterNivel').onchange = filterCards;
            document.getElementById('cancelViewCardButton').onclick = () => document.getElementById('viewCardModal').classList.remove('show');
            document.getElementById('buyCardButton').onclick = buyCard;
            document.onkeydown = e => e.key === 'Escape' && document.querySelectorAll('.modal.show').forEach(m => m.classList.remove('show'));
            await loadCards();
        });
        async function loadCards() {
            toggleLoader(true);
            try {
                const token = localStorage.getItem('token');
                const res = await fetch('/api/cards', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                cardsCache = await res.json();
                renderCards(cardsCache);
            } catch (err) {
                showNotification('Erro ao carregar cartões.', true);
            } finally {
                toggleLoader(false);
            }
        }
        function renderCards(cards) {
            const tbody = document.querySelector('#cardList tbody');
            tbody.innerHTML = cards.map(c => `
                <tr>
                    <td>${sanitizeInput(formatCardNumber(c.numero))}</td>
                    <td>${sanitizeInput(c.bandeira)}</td>
                    <td>${sanitizeInput(c.banco)}</td>
                    <td>${sanitizeInput(c.nivel)}</td>
                    <td>${formatCurrency(c.price)}</td>
                    <td><button class="action-button view-card-button" data-card-id="${c._id}" aria-label="Visualizar cartão"><i class="fas fa-eye"></i></button></td>
                </tr>
            `).join('');
            document.querySelectorAll('.view-card-button').forEach(btn => {
                btn.onclick = () => {
                    const card = cardsCache.find(c => c._id === btn.dataset.cardId);
                    document.getElementById('viewCardNumber').textContent = formatCardNumber(card.numero);
                    document.getElementById('viewCardCvv').textContent = card.cvv;
                    document.getElementById('viewCardExpiry').textContent = card.expiry;
                    document.getElementById('viewCardName').textContent = card.name;
                    document.getElementById('viewCardCpf').textContent = formatCpf(card.cpf);
                    document.getElementById('viewCardBandeira').textContent = card.bandeira;
                    document.getElementById('viewCardBanco').textContent = card.banco;
                    document.getElementById('viewCardNivel').textContent = card.nivel;
                    document.getElementById('viewCardPrice').textContent = formatCurrency(card.price);
                    document.getElementById('viewCardModal').dataset.cardId = card._id;
                    const modal = document.getElementById('viewCardModal');
                    modal.classList.add('show');
                    modal.querySelector('button').focus();
                };
            });
        }
        function filterCards() {
            const query = sanitizeInput(document.getElementById('searchCard').value).replace(/\s/g, '');
            const bandeira = sanitizeInput(document.getElementById('filterBandeira').value);
            const banco = sanitizeInput(document.getElementById('filterBanco').value);
            const nivel = sanitizeInput(document.getElementById('filterNivel').value);
            const filtered = cardsCache.filter(c =>
                (!query || c.numero.includes(query)) &&
                (!bandeira || c.bandeira === bandeira) &&
                (!banco || c.banco === banco) &&
                (!nivel || c.nivel === nivel)
            );
            renderCards(filtered);
        }
        async function buyCard() {
            const btn = document.getElementById('buyCardButton');
            const spinner = document.getElementById('buyCardSpinner');
            const errDiv = document.getElementById('viewCardError');
            btn.disabled = true;
            btn.setAttribute('aria-busy', 'true');
            spinner.classList.remove('hidden');
            toggleLoader(true);
            errDiv.classList.add('hidden');
            try {
                const cardId = document.getElementById('viewCardModal').dataset.cardId;
                const userId = localStorage.getItem('userId');
                const token = localStorage.getItem('token');
                if (!cardId || !userId) throw new Error('ID do cartão ou usuário inválido.');
                const res = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ userId, cardId })
                });
                const data = await res.json();
                if (res.status !== 200) throw new Error(data.error);
                showNotification('Cartão comprado com sucesso!');
                document.getElementById('viewCardModal').classList.remove('show');
                const userRes = await fetch(`/api/users?userId=${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await userRes.json();
                document.getElementById('userBalance').textContent = `Saldo: ${formatCurrency(user.balance)}`;
                await loadCards();
            } catch (err) {
                errDiv.textContent = err.message;
                errDiv.classList.remove('hidden');
                showNotification(`Erro: ${err.message}`, true);
            } finally {
                btn.disabled = false;
                btn.setAttribute('aria-busy', 'false');
                spinner.classList.add('hidden');
                toggleLoader(false);
            }
        }
    </script>
</body>
</html>
