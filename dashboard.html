<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGAN CC's - Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.8/inputmask.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        #globalLoader{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;visibility:hidden;z-index:9999}.spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid #10b981;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}#notifications{position:fixed;top:1rem;right:1rem;max-width:300px;z-index:10000}.notification{background:#1f2937;color:white;padding:1rem;border-radius:6px;margin-bottom:0.5rem;box-shadow:0 2px 4px rgba(0,0,0,0.2);display:flex;justify-content:space-between}.notification-error{background:#ef4444}.notification-success{background:#10b981}#debug{position:fixed;bottom:1rem;left:1rem;background:#1a202c;color:white;padding:1rem;border-radius:6px;max-width:300px;font-size:0.75rem;overflow-y:auto;max-height:160px}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center}.modal.show{display:flex}table{width:100%;border-collapse:collapse}th,td{padding:0.75rem;text-align:left;border-bottom:1px solid #4b5563}th{background:#1f2937;font-weight:600}.action-button,.delete-button{padding:0.5rem;border-radius:4px;margin-right:0.5rem}.action-button{background:#3b82f6;color:white}.action-button:hover{background:#2563eb}.delete-button{background:#ef4444;color:white}.delete-button:hover{background:#dc2626}
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div id="globalLoader"><div class="spinner"></div></div>
    <div id="notifications"></div>
    <header class="bg-gray-800 p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-green-500">LOGAN CC's - Admin</h1>
        <div class="flex items-center space-x-4">
            <button id="shopButton" class="text-gray-300 hover:text-green-500"><i class="fas fa-store mr-2"></i>Loja</button>
            <button id="logoutButton" class="text-gray-300 hover:text-red-500"><i class="fas fa-sign-out-alt"></i>Sair</button>
        </div>
    </header>
    <main class="container mx-auto p-6">
        <div id="adminAuthSection" class="bg-gray-800 p-4 rounded-lg mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-lock mr-2"></i>Autenticação Admin</h2>
            <label for="adminPassword" class="block text-sm font-medium">Senha</label>
            <input type="password" id="adminPassword" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required aria-describedby="adminAuthError">
            <p id="adminAuthError" class="text-red-500 text-sm hidden"></p>
            <div class="flex justify-end mt-4">
                <button id="verifyAdminButton" class="py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600 flex items-center">
                    <span>Verificar</span>
                    <svg id="verifySpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"/><path fill="currentColor" d="M4 12a8 8 0 018-8v8H4z" class="opacity-75"/></svg>
                </button>
            </div>
        </div>
        <div id="levelsSection" class="bg-gray-800 p-4 rounded-lg mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-layer-group mr-2"></i>Níveis</h2>
            <div id="levelList" class="overflow-x-auto">
                <table><thead><tr><th>Nível</th><th>Preço</th><th>Ações</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
        <div id="usersSection" class="bg-gray-800 p-4 rounded-lg mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold"><i class="fas fa-users mr-2"></i>Usuários</h2>
                <div class="flex space-x-2">
                    <input id="searchUser" class="p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="Buscar por ID/Usuário">
                    <button id="addUserButton" class="py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600"><i class="fas fa-user-plus mr-2"></i>Adicionar</button>
                </div>
            </div>
            <div id="userList" class="overflow-x-auto">
                <table><thead><tr><th>ID</th><th>Usuário</th><th>Saldo</th><th>Admin</th><th>Ações</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
        <div id="cardsSection" class="bg-gray-800 p-4 rounded-lg hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold"><i class="fas fa-credit-card mr-2"></i>Cartões</h2>
                <div class="space-x-2">
                    <button id="addCardButton" class="py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600"><i class="fas fa-plus mr-2"></i>Adicionar</button>
                    <button id="importCardsButton" class="py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600"><i class="fas fa-upload mr-2"></i>Importar .xlsx</button>
                </div>
            </div>
            <input type="file" id="importCardsInput" accept=".xlsx" class="hidden">
            <div id="adminCardList" class="overflow-x-auto">
                <table><thead><tr><th>Número</th><th>Bandeira</th><th>Banco</th><th>Nível</th><th>Preço</th><th>Adquirido</th><th>Ações</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </main>
    <div id="adminAuthModal" class="modal">
        <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-lock mr-2"></i>Autenticação Admin</h2>
            <label for="modalAdminPassword" class="block text-sm font-medium">Senha</label>
            <input type="password" id="modalAdminPassword" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required aria-describedby="modalAdminAuthError">
            <p id="modalAdminAuthError" class="text-red-500 text-sm hidden"></p>
            <div class="flex justify-end mt-4">
                <button id="modalVerifyAdminButton" class="py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600 flex items-center">
                    <span>Verificar</span>
                    <svg id="modalVerifySpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"/><path fill="currentColor" d="M4 12a8 8 0 018-8v8H4z" class="opacity-75"/></svg>
                </button>
            </div>
        </div>
    </div>
    <div id="addUserModal" class="modal">
        <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-user-plus mr-2"></i>Adicionar Usuário</h2>
            <div class="space-y-4">
                <div><label for="newUsername" class="block text-sm font-medium">Usuário</label><input id="newUsername" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="ex.: teste123" required pattern="[a-zA-Z0-9]{3,}"></div>
                <div><label for="newPassword" class="block text-sm font-medium">Senha</label><input type="password" id="newPassword" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="Mín. 4 caracteres" required minlength="4"></div>
                <div><label for="newBalance" class="block text-sm font-medium">Saldo Inicial</label><input type="number" id="newBalance" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="ex.: 0.00" step="0.01" min="0" required></div>
                <div><label for="newIsAdmin" class="block text-sm font-medium">Admin</label><select id="newIsAdmin" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500"><option value="false">Não</option><option value="true">Sim</option></select></div>
            </div>
            <p id="addUserError" class="text-red-500 text-sm hidden"></p>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="cancelAddUserButton" class="py-2 px-4 bg-gray-600 text-white rounded hover:bg-gray-700"><i class="fas fa-times mr-2"></i>Cancelar</button>
                <button id="addUserConfirmButton" class="py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600 flex items-center">
                    <span>Adicionar</span><svg id="addUserSpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"/><path fill="currentColor" d="M4 12a8 8 0 018-8v8H4z" class="opacity-75"/></svg>
                </button>
            </div>
        </div>
    </div>
    <div id="editUserModal" class="modal">
        <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-user-edit mr-2"></i>Editar Usuário</h2>
            <div class="space-y-4">
                <div><label for="editUserId" class="block text-sm font-medium">ID</label><input id="editUserId" readonly class="mt-1 w-full p-2 bg-gray-600 rounded"></div>
                <div><label for="editUsername" class="block text-sm font-medium">Usuário</label><input id="editUsername" readonly class="mt-1 w-full p-2 bg-gray-600 rounded"></div>
                <div><label for="editPassword" class="block text-sm font-medium">Nova Senha (opcional)</label><input type="password" id="editPassword" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="Deixe em branco para manter" minlength="4"></div>
                <div><label for="editBalance" class="block text-sm font-medium">Saldo</label><input type="number" id="editBalance" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" step="0.01" min="0" required></div>
                <div><label for="editIsAdmin" class="block text-sm font-medium">Admin</label><select id="editIsAdmin" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500"><option value="false">Não</option><option value="true">Sim</option></select></div>
            </div>
            <p id="editUserError" class="text-red-500 text-sm hidden"></p>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="cancelEditUserButton" class="py-2 px-4 bg-gray-600 text-white rounded hover:bg-gray-700"><i class="fas fa-times mr-2"></i>Cancelar</button>
                <button id="saveUserButton" class="py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600 flex items-center">
                    <span>Salvar</span><svg id="saveUserSpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"/><path fill="currentColor" d="M4 12a8 8 0 018-8v8H4z" class="opacity-75"/></svg>
                </button>
            </div>
        </div>
    </div>
    <div id="editLevelModal" class="modal">
        <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-layer-group mr-2"></i>Editar Preço do Nível</h2>
            <div class="space-y-4">
                <div><label for="editLevelName" class="block text-sm font-medium">Nível</label><input id="editLevelName" readonly class="mt-1 w-full p-2 bg-gray-600 rounded"></div>
                <div><label for="editLevelPrice" class="block text-sm font-medium">Preço</label><input type="number" id="editLevelPrice" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" step="0.01" min="0.01" required></div>
            </div>
            <p id="editLevelError" class="text-red-500 text-sm hidden"></p>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="cancelEditLevelButton" class="py-2 px-4 bg-gray-600 text-white rounded hover:bg-gray-700"><i class="fas fa-times mr-2"></i>Cancelar</button>
                <button id="saveLevelButton" class="py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600 flex items-center">
                    <span>Salvar</span><svg id="saveLevelSpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"/><path fill="currentColor" d="M4 12a8 8 0 018-8v8H4z" class="opacity-75"/></svg>
                </button>
            </div>
        </div>
    </div>
    <div id="addCardModal" class="modal">
        <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-plus mr-2"></i>Adicionar Cartão</h2>
            <div class="space-y-4">
                <div><label for="cardNumber" class="block text-sm font-medium">Número</label><input id="cardNumber" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="1234 5678 9012 3456" required pattern="\d{16}"></div>
                <div><label for="cardCvv" class="block text-sm font-medium">CVV</label><input id="cardCvv" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required pattern="\d{3}"></div>
                <div><label for="cardExpiry" class="block text-sm font-medium">Validade</label><input id="cardExpiry" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="MM/AA" required pattern="\d{2}/\d{2}"></div>
                <div><label for="cardName" class="block text-sm font-medium">Nome</label><input id="cardName" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required></div>
                <div><label for="cardCpf" class="block text-sm font-medium">CPF</label><input id="cardCpf" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required pattern="\d{11}"></div>
                <div><label for="cardBandeira" class="block text-sm font-medium">Bandeira</label><select id="cardBandeira" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required><option value="Visa">Visa</option><option value="Mastercard">Mastercard</option><option value="Amex">Amex</option><option value="Elo">Elo</option><option value="Hipercard">Hipercard</option><option value="Diners Club">Diners Club</option></select></div>
                <div><label for="cardBanco" class="block text-sm font-medium">Banco</label><select id="cardBanco" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required><option value="Nubank">Nubank</option><option value="Itaú">Itaú</option><option value="Bradesco">Bradesco</option><option value="Santander">Santander</option><option value="Banco do Brasil">Banco do Brasil</option><option value="Caixa Econômica Federal">Caixa Econômica Federal</option><option value="Sicredi">Sicredi</option><option value="Sicoob">Sicoob</option></select></div>
                <div><label for="cardNivel" class="block text-sm font-medium">Nível</label><select id="cardNivel" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required><option value="Classic">Classic</option><option value="Gold">Gold</option><option value="Platinum">Platinum</option><option value="Black">Black</option></select></div>
            </div>
            <p id="addCardError" class="text-red-500 text-sm hidden"></p>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="cancelAddCardButton" class="py-2 px-4 bg-gray-600 text-white rounded hover:bg-gray-700"><i class="fas fa-times mr-2"></i>Cancelar</button>
                <button id="addCardConfirmButton" class="py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600 flex items-center">
                    <span>Adicionar</span><svg id="addCardSpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"/><path fill="currentColor" d="M4 12a8 8 0 018-8v8H4z" class="opacity-75"/></svg>
                </button>
            </div>
        </div>
    </div>
    <div id="editCardModal" class="modal">
        <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-semibold mb-4"><i class="fas fa-credit-card mr-2"></i>Editar Cartão</h2>
            <div class="space-y-4">
                <div><label for="editCardNumber" class="block text-sm font-medium">Número</label><input id="editCardNumber" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required pattern="\d{16}"></div>
                <div><label for="editCardCvv" class="block text-sm font-medium">CVV</label><input id="editCardCvv" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required pattern="\d{3}"></div>
                <div><label for="editCardExpiry" class="block text-sm font-medium">Validade</label><input id="editCardExpiry" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="MM/AA" required pattern="\d{2}/\d{2}"></div>
                <div><label for="editCardName" class="block text-sm font-medium">Nome</label><input id="editCardName" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required></div>
                <div><label for="editCardCpf" class="block text-sm font-medium">CPF</label><input id="editCardCpf" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required pattern="\d{11}"></div>
                <div><label for="editCardBandeira" class="block text-sm font-medium">Bandeira</label><select id="editCardBandeira" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required><option value="Visa">Visa</option><option value="Mastercard">Mastercard</option><option value="Amex">Amex</option><option value="Elo">Elo</option><option value="Hipercard">Hipercard</option><option value="Diners Club">Diners Club</option></select></div>
                <div><label for="editCardBanco" class="block text-sm font-medium">Banco</label><select id="editCardBanco" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required><option value="Nubank">Nubank</option><option value="Itaú">Itaú</option><option value="Bradesco">Bradesco</option><option value="Santander">Santander</option><option value="Banco do Brasil">Banco do Brasil</option><option value="Caixa Econômica Federal">Caixa Econômica Federal</option><option value="Sicredi">Sicredi</option><option value="Sicoob">Sicoob</option></select></div>
                <div><label for="editCardNivel" class="block text-sm font-medium">Nível</label><select id="editCardNivel" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" required><option value="Classic">Classic</option><option value="Gold">Gold</option><option value="Platinum">Platinum</option><option value="Black">Black</option></select></div>
            </div>
            <p id="editCardError" class="text-red-500 text-sm hidden"></p>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="cancelEditCardButton" class="py-2 px-4 bg-gray-600 text-white rounded hover:bg-gray-700"><i class="fas fa-times mr-2"></i>Cancelar</button>
                <button id="saveCardButton" class="py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600 flex items-center">
                    <span>Salvar</span><svg id="saveCardSpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"/><path fill="currentColor" d="M4 12a8 8 0 018-8v8H4z" class="opacity-75"/></svg>
                </button>
            </div>
        </div>
    </div>
    <div id="debug" class="fixed bottom-4 left-4 bg-gray-900 text-white p-4 rounded-md max-w-xs text-xs overflow-y-auto max-h-40"></div>
    <script src="debug.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.9/purify.min.js"></script>
    <script>
        const sanitizeInput=input=>DOMPurify?.sanitize?DOMPurify.sanitize(input):input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,'').replace(/[<>]/g,'');
        const formatCurrency=value=>new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(value);
        const showNotification=(msg,isError=false)=>{const n=document.createElement('div');n.className=`notification ${isError?'notification-error':'notification-success'}`;n.innerHTML=`${sanitizeInput(msg)}<button class="ml-2 text-white hover:text-gray-300"><i class="fas fa-times"></i></button>`;document.getElementById('notifications').appendChild(n);n.querySelector('button').onclick=()=>n.remove();setTimeout(()=>n.remove(),3000)};
        const toggleLoader=show=>document.getElementById('globalLoader').style.visibility=show?'visible':'hidden';
        const applyInputMasks=()=>{['cardNumber','editCardNumber'].forEach(id=>Inputmask({mask:"9999 9999 9999 9999"}).mask(document.getElementById(id)));['cardCvv','editCardCvv'].forEach(id=>Inputmask({mask:"999"}).mask(document.getElementById(id)));['cardExpiry','editCardExpiry'].forEach(id=>Inputmask({mask:"99/99",placeholder:"MM/AA"}).mask(document.getElementById(id)));['cardCpf','editCardCpf'].forEach(id=>Inputmask({mask:"999.999.999-99"}).mask(document.getElementById(id)))};
        const handleError=(err,errDiv,btn,spinner,isModal=false)=>{errDiv.textContent=err.message;errDiv.classList.remove('hidden');showNotification(`Erro: ${err.message}`,true);btn.disabled=false;spinner.classList.add('hidden');toggleLoader(false);if(isModal)document.querySelector('.modal.show').classList.remove('show')};
        document.addEventListener('DOMContentLoaded',async()=>{
            const userId=localStorage.getItem('userId');
            if(!userId){window.location.href='index.html';return}
            toggleLoader(true);
            try{
                const res=await fetch(`/api/users?userId=${userId}`);
                const user=await res.json();
                if(!user.is_admin){showNotification('Acesso negado. Apenas admins.',true);setTimeout(()=>window.location.href='shop.html',1000);return}
                document.getElementById('adminAuthSection').classList.remove('hidden');
            }catch(err){
                showNotification('Erro ao carregar dashboard.',true);
                localStorage.clear();
                setTimeout(()=>window.location.href='index.html',1000);
            }finally{
                toggleLoader(false);
            }
            applyInputMasks();
            document.getElementById('logoutButton').onclick=()=>{localStorage.clear();window.location.href='index.html'};
            document.getElementById('shopButton').onclick=()=>window.location.href='shop.html';
            ['verifyAdminButton','modalVerifyAdminButton'].forEach(id=>document.getElementById(id).onclick=verifyAdmin);
            document.getElementById('addUserButton').onclick=()=>{document.getElementById('addUserModal').classList.add('show');document.getElementById('newUsername').focus()};
            document.getElementById('cancelAddUserButton').onclick=()=>document.getElementById('addUserModal').classList.remove('show');
            document.getElementById('addUserConfirmButton').onclick=addUser;
            document.getElementById('cancelEditUserButton').onclick=()=>document.getElementById('editUserModal').classList.remove('show');
            document.getElementById('saveUserButton').onclick=saveUser;
            document.getElementById('addCardButton').onclick=()=>{document.getElementById('addCardModal').classList.add('show');document.getElementById('cardNumber').focus()};
            document.getElementById('cancelAddCardButton').onclick=()=>document.getElementById('addCardModal').classList.remove('show');
            document.getElementById('addCardConfirmButton').onclick=addCard;
            document.getElementById('cancelEditCardButton').onclick=()=>document.getElementById('editCardModal').classList.remove('show');
            document.getElementById('saveCardButton').onclick=saveCard;
            document.getElementById('importCardsButton').onclick=()=>document.getElementById('importCardsInput').click();
            document.getElementById('importCardsInput').onchange=importCards;
            document.getElementById('searchUser').oninput=searchUsers;
            document.getElementById('cancelEditLevelButton').onclick=()=>document.getElementById('editLevelModal').classList.remove('show');
            document.getElementById('saveLevelButton').onclick=saveLevel;
            document.onkeydown=e=>e.key==='Escape'&&document.querySelectorAll('.modal.show').forEach(m=>m.classList.remove('show'));
        });
        async function verifyAdmin(){
            const btn=this,spinner=btn.querySelector('svg'),isModal=btn.id==='modalVerifyAdminButton',errDiv=document.getElementById(isModal?'modalAdminAuthError':'adminAuthError'),pwdInput=document.getElementById(isModal?'modalAdminPassword':'adminPassword');
            btn.disabled=true;spinner.classList.remove('hidden');toggleLoader(true);errDiv.classList.add('hidden');
            try{
                const res=await fetch('/api/verify-admin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:localStorage.getItem('userId'),adminPassword:sanitizeInput(pwdInput.value)})});
                const data=await res.json();
                if(res.status!==200)throw new Error(data.error);
                showNotification('Autenticação bem-sucedida!');
                document.getElementById('adminAuthSection').classList.add('hidden');
                document.getElementById('adminAuthModal').classList.remove('show');
                ['usersSection','cardsSection','levelsSection'].forEach(id=>document.getElementById(id).classList.remove('hidden'));
                await Promise.all([loadUsers(),loadCards(),loadLevels()]);
            }catch(err){
                handleError(err,errDiv,btn,spinner);
            }finally{
                btn.disabled=false;spinner.classList.add('hidden');toggleLoader(false);
            }
        }
        async function loadLevels(){
            toggleLoader(true);
            try{
                const res=await fetch('/api/admin/levels');
                const levels=await res.json();
                const tbody=document.querySelector('#levelList tbody');
                tbody.innerHTML=levels.map(l=>`<tr><td>${sanitizeInput(l.level)}</td><td>${formatCurrency(l.price)}</td><td><button class="action-button edit-level-button" data-level="${l.level}"><i class="fas fa-edit"></i></button></td></tr>`).join('');
                document.querySelectorAll('.edit-level-button').forEach(btn=>btn.onclick=()=>{
                    const level=btn.dataset.level;
                    document.getElementById('editLevelName').value=level;
                    document.getElementById('editLevelPrice').value=levels.find(l=>l.level===level).price;
                    document.getElementById('editLevelModal').classList.add('show');
                    document.getElementById('editLevelPrice').focus();
                });
            }catch(err){
                showNotification('Erro ao carregar níveis.',true);
            }finally{
                toggleLoader(false);
            }
        }
        async function saveLevel(){
            const btn=document.getElementById('saveLevelButton'),spinner=document.getElementById('saveLevelSpinner'),errDiv=document.getElementById('editLevelError');
            btn.disabled=true;spinner.classList.remove('hidden');toggleLoader(true);errDiv.classList.add('hidden');
            try{
                const level=sanitizeInput(document.getElementById('editLevelName').value),price=parseFloat(document.getElementById('editLevelPrice').value);
                if(price<=0)throw new Error('Preço deve ser maior que 0.');
                const res=await fetch(`/api/admin/levels/${level}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({price})});
                const data=await res.json();
                if(res.status!==200)throw new Error(data.error);
                showNotification('Preço do nível atualizado!');
                document.getElementById('editLevelModal').classList.remove('show');
                await Promise.all([loadLevels(),loadCards()]);
            }catch(err){
                handleError(err,errDiv,btn,spinner);
            }finally{
                btn.disabled=false;spinner.classList.add('hidden');toggleLoader(false);
            }
        }
        async function loadUsers(){
            toggleLoader(true);
            try{
                const res=await fetch('/api/admin/users');
                const users=await res.json();
                const tbody=document.querySelector('#userList tbody');
                tbody.innerHTML=users.map(u=>`<tr><td>${sanitizeInput(u.userId)}</td><td>${sanitizeInput(u.username)}</td><td>${formatCurrency(u.balance)}</td><td>${u.is_admin?'Sim':'Não'}</td><td><button class="action-button edit-user-button" data-user-id="${u.userId}"><i class="fas fa-edit"></i></button><button class="delete-button delete-user-button" data-user-id="${u.userId}"><i class="fas fa-trash"></i></button></td></tr>`).join('');
                document.querySelectorAll('.edit-user-button').forEach(btn=>btn.onclick=async()=>{
                    try{
                        const res=await fetch(`/api/admin/users/${btn.dataset.userId}`);
                        const user=await res.json();
                        document.getElementById('editUserId').value=user.userId;
                        document.getElementById('editUsername').value=user.username;
                        document.getElementById('editBalance').value=user.balance;
                        document.getElementById('editIsAdmin').value=user.is_admin.toString();
                        document.getElementById('editUserModal').classList.add('show');
                        document.getElementById('editBalance').focus();
                    }catch(err){
                        showNotification('Erro ao carregar usuário.',true);
                    }
                });
                document.querySelectorAll('.delete-user-button').forEach(btn=>btn.onclick=async()=>{
                    if(!confirm('Confirma a exclusão deste usuário?'))return;
                    toggleLoader(true);
                    try{
                        const res=await fetch(`/api/admin/users/${btn.dataset.userId}`,{method:'DELETE'});
                        const data=await res.json();
                        if(res.status!==200)throw new Error(data.error);
                        showNotification('Usuário excluído!');
                        await loadUsers();
                    }catch(err){
                        showNotification(`Erro: ${err.message}`,true);
                    }finally{
                        toggleLoader(false);
                    }
                });
            }catch(err){
                showNotification('Erro ao carregar usuários.',true);
            }finally{
                toggleLoader(false);
            }
        }
        async function addUser(){
            const btn=document.getElementById('addUserConfirmButton'),spinner=document.getElementById('addUserSpinner'),errDiv=document.getElementById('addUserError');
            btn.disabled=true;spinner.classList.remove('hidden');toggleLoader(true);errDiv.classList.add('hidden');
            try{
                const username=sanitizeInput(document.getElementById('newUsername').value.trim()),password=sanitizeInput(document.getElementById('newPassword').value),balance=parseFloat(document.getElementById('newBalance').value),isAdmin=document.getElementById('newIsAdmin').value==='true';
                if(!username.match(/^[a-zA-Z0-9]{3,}$/))throw new Error('Usuário deve ter 3+ caracteres alfanuméricos.');
                if(password.length<4)throw new Error('Senha deve ter 4+ caracteres.');
                const res=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password,balance,isAdmin})});
                const data=await res.json();
                if(res.status!==200)throw new Error(data.error);
                showNotification('Usuário adicionado!');
                document.getElementById('addUserModal').classList.remove('show');
                await loadUsers();
            }catch(err){
                handleError(err,errDiv,btn,spinner);
            }finally{
                btn.disabled=false;spinner.classList.add('hidden');toggleLoader(false);
            }
        }
        async function saveUser(){
            const btn=document.getElementById('saveUserButton'),spinner=document.getElementById('saveUserSpinner'),errDiv=document.getElementById('editUserError');
            btn.disabled=true;spinner.classList.remove('hidden');toggleLoader(true);errDiv.classList.add('hidden');
            try{
                const userId=sanitizeInput(document.getElementById('editUserId').value),password=sanitizeInput(document.getElementById('editPassword').value),balance=parseFloat(document.getElementById('editBalance').value),isAdmin=document.getElementById('editIsAdmin').value==='true';
                if(password&&password.length<4)throw new Error('Senha deve ter 4+ caracteres.');
                const updateData={balance,isAdmin};
                if(password)updateData.password=password;
                const res=await fetch(`/api/admin/users/${userId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(updateData)});
                const data=await res.json();
                if(res.status!==200)throw new Error(data.error);
                showNotification('Usuário atualizado!');
                document.getElementById('editUserModal').classList.remove('show');
                await loadUsers();
            }catch(err){
                handleError(err,errDiv,btn,spinner);
            }finally{
                btn.disabled=false;spinner.classList.add('hidden');toggleLoader(false);
            }
        }
        async function loadCards(){
            toggleLoader(true);
            try{
                const res=await fetch('/api/admin/cards');
                const cards=await res.json();
                const tbody=document.querySelector('#adminCardList tbody');
                tbody.innerHTML=cards.map(c=>`<tr><td>${sanitizeInput(c.numero)}</td><td>${sanitizeInput(c.bandeira)}</td><td>${sanitizeInput(c.banco)}</td><td>${sanitizeInput(c.nivel)}</td><td>${formatCurrency(c.price)}</td><td>${c.acquired?`Sim (ID: ${sanitizeInput(c.acquiredBy)})`:'Não'}</td><td><button class="action-button edit-card-button" data-card-id="${c._id}"><i class="fas fa-edit"></i></button><button class="delete-button delete-card-button" data-card-id="${c._id}"><i class="fas fa-trash"></i></button></td></tr>`).join('');
                document.querySelectorAll('.edit-card-button').forEach(btn=>btn.onclick=async()=>{
                    try{
                        const res=await fetch(`/api/admin/cards/${btn.dataset.cardId}`);
                        const card=await res.json();
                        document.getElementById('editCardNumber').value=card.numero.replace(/(\d{4})(\d{4})(\d{4})(\d{4})/,'$1 $2 $3 $4');
                        document.getElementById('editCardCvv').value=card.cvv;
                        document.getElementById('editCardExpiry').value=card.validade;
                        document.getElementById('editCardName').value=card.nome;
                        document.getElementById('editCardCpf').value=card.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4');
                        document.getElementById('editCardBandeira').value=card.bandeira;
                        document.getElementById('editCardBanco').value=card.banco;
                        document.getElementById('editCardNivel').value=card.nivel;
                        document.getElementById('editCardModal').classList.add('show');
                        document.getElementById('editCardModal').dataset.cardId=card._id;
                        document.getElementById('editCardNumber').focus();
                    }catch(err){
                        showNotification('Erro ao carregar cartão.',true);
                    }
                });
                document.querySelectorAll('.delete-card-button').forEach(btn=>btn.onclick=async()=>{
                    if(!confirm('Confirma a exclusão deste cartão?'))return;
                    toggleLoader(true);
                    try{
                        const res=await fetch(`/api/admin/cards/${btn.dataset.cardId}`,{method:'DELETE'});
                        const data=await res.json();
                        if(res.status!==200)throw new Error(data.error);
                        showNotification('Cartão excluído!');
                        await loadCards();
                    }catch(err){
                        showNotification(`Erro: ${err.message}`,true);
                    }finally{
                        toggleLoader(false);
                    }
                });
            }catch(err){
                showNotification('Erro ao carregar cartões.',true);
            }finally{
                toggleLoader(false);
            }
        }
        async function addCard(){
            const btn=document.getElementById('addCardConfirmButton'),spinner=document.getElementById('addCardSpinner'),errDiv=document.getElementById('addCardError');
            btn.disabled=true;spinner.classList.remove('hidden');toggleLoader(true);errDiv.classList.add('hidden');
            try{
                const card={
                    numero:sanitizeInput(document.getElementById('cardNumber').value.replace(/\s/g,'')),
                    cvv:sanitizeInput(document.getElementById('cardCvv').value),
                    validade:sanitizeInput(document.getElementById('cardExpiry').value),
                    nome:sanitizeInput(document.getElementById('cardName').value),
                    cpf:sanitizeInput(document.getElementById('cardCpf').value.replace(/[\.-]/g,'')),
                    bandeira:sanitizeInput(document.getElementById('cardBandeira').value),
                    banco:sanitizeInput(document.getElementById('cardBanco').value),
                    nivel:sanitizeInput(document.getElementById('cardNivel').value)
                };
                const res=await fetch('/api/admin/cards',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(card)});
                const data=await res.json();
                if(res.status!==200)throw new Error(data.error);
                showNotification('Cartão adicionado!');
                document.getElementById('addCardModal').classList.remove('show');
                await loadCards();
            }catch(err){
                handleError(err,errDiv,btn,spinner);
            }finally{
                btn.disabled=false;spinner.classList.add('hidden');toggleLoader(false);
            }
        }
        async function saveCard(){
            const btn=document.getElementById('saveCardButton'),spinner=document.getElementById('saveCardSpinner'),errDiv=document.getElementById('editCardError');
            btn.disabled=true;spinner.classList.remove('hidden');toggleLoader(true);errDiv.classList.add('hidden');
            try{
                const cardId=document.getElementById('editCardModal').dataset.cardId,card={
                    numero:sanitizeInput(document.getElementById('editCardNumber').value.replace(/\s/g,'')),
                    cvv:sanitizeInput(document.getElementById('editCardCvv').value),
                    validade:sanitizeInput(document.getElementById('editCardExpiry').value),
                    nome:sanitizeInput(document.getElementById('editCardName').value),
                    cpf:sanitizeInput(document.getElementById('editCardCpf').value.replace(/[\.-]/g,'')),
                    bandeira:sanitizeInput(document.getElementById('editCardBandeira').value),
                    banco:sanitizeInput(document.getElementById('editCardBanco').value),
                    nivel:sanitizeInput(document.getElementById('editCardNivel').value)
                };
                const res=await fetch(`/api/admin/cards/${cardId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(card)});
                const data=await res.json();
                if(res.status!==200)throw new Error(data.error);
                showNotification('Cartão atualizado!');
                document.getElementById('editCardModal').classList.remove('show');
                await loadCards();
            }catch(err){
                handleError(err,errDiv,btn,spinner);
            }finally{
                btn.disabled=false;spinner.classList.add('hidden');toggleLoader(false);
            }
        }
        async function importCards(e){
            toggleLoader(true);
            try{
                const file=e.target.files[0];
                const data=await file.arrayBuffer();
                const workbook=XLSX.read(data);
                const sheet=workbook.Sheets[workbook.SheetNames[0]];
                const cards=XLSX.utils.sheet_to_json(sheet).map(row=>({
                    numero:String(row.numero),
                    cvv:String(row.cvv),
                    validade:String(row.validade),
                    nome:String(row.nome),
                    cpf:String(row.cpf),
                    bandeira:String(row.bandeira),
                    banco:String(row.banco),
                    nivel:String(row.nivel)
                }));
                const res=await fetch('/api/admin/cards/bulk',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({cards})});
                const resData=await res.json();
                if(res.status!==200)throw new Error(resData.error);
                showNotification('Cartões importados!');
                await loadCards();
                e.target.value='';
            }catch(err){
                showNotification(`Erro ao importar: ${err.message}`,true);
            }finally{
                toggleLoader(false);
            }
        }
        async function searchUsers(e){
            const query=sanitizeInput(e.target.value).toLowerCase();
            try{
                const res=await fetch('/api/admin/users');
                const users=await res.json();
                const filtered=query?users.filter(u=>u.userId.includes(query)||u.username.toLowerCase().includes(query)):users;
                const tbody=document.querySelector('#userList tbody');
                tbody.innerHTML=filtered.map(u=>`<tr><td>${sanitizeInput(u.userId)}</td><td>${sanitizeInput(u.username)}</td><td>${formatCurrency(u.balance)}</td><td>${u.is_admin?'Sim':'Não'}</td><td><button class="action-button edit-user-button" data-user-id="${u.userId}"><i class="fas fa-edit"></i></button><button class="delete-button delete-user-button" data-user-id="${u.userId}"><i class="fas fa-trash"></i></button></td></tr>`).join('');
                document.querySelectorAll('.edit-user-button').forEach(btn=>btn.onclick=async()=>{
                    try{
                        const res=await fetch(`/api/admin/users/${btn.dataset.userId}`);
                        const user=await res.json();
                        document.getElementById('editUserId').value=user.userId;
                        document.getElementById('editUsername').value=user.username;
                        document.getElementById('editBalance').value=user.balance;
                        document.getElementById('editIsAdmin').value=user.is_admin.toString();
                        document.getElementById('editUserModal').classList.add('show');
                        document.getElementById('editBalance').focus();
                    }catch(err){
                        showNotification('Erro ao carregar usuário.',true);
                    }
                });
                document.querySelectorAll('.delete-user-button').forEach(btn=>btn.onclick=async()=>{
                    if(!confirm('Confirma a exclusão?'))return;
                    toggleLoader(true);
                    try{
                        const res=await fetch(`/api/admin/users/${btn.dataset.userId}`,{method:'DELETE'});
                        const data=await res.json();
                        if(res.status!==200)throw new Error(data.error);
                        showNotification('Usuário excluído!');
                        await loadUsers();
                    }catch(err){
                        showNotification(`Erro: ${err.message}`,true);
                    }finally{
                        toggleLoader(false);
                    }
                });
            }catch(err){
                showNotification('Erro ao buscar usuários.',true);
            }
        }
    </script>
</body>
</html>
