<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOGAN CC's - Loja</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.0/purify.min.js"></script>
  <style>
    #debug { 
      position: fixed; 
      bottom: 4rem; 
      left: 1rem; 
      background: #1f2937; 
      color: white; 
      padding: 1rem; 
      border-radius: 0.5rem; 
      max-width: 400px; 
      max-height: 300px; 
      overflow-y: auto; 
      z-index: 1000; 
      font-size: 0.75rem; 
      display: block; 
    }
    #toggleDebug { 
      position: fixed; 
      bottom: 1rem; 
      left: 1rem; 
      background: #10b981; 
      color: white; 
      padding: 0.5rem 1rem; 
      border-radius: 0.25rem; 
      cursor: pointer; 
      z-index: 1001; 
    }
    .debug-info { color: #10b981; }
    .debug-warn { color: #f59e0b; }
    .debug-error { color: #ef4444; }
    .debug-success { color: #10b981; }
    #notifications { 
      position: fixed; 
      top: 1rem; 
      right: 1rem; 
      z-index: 10000; 
      max-width: 320px; 
    }
    .notification { 
      background: #1f2937; 
      color: white; 
      padding: 1rem; 
      border-radius: 0.5rem; 
      margin-bottom: 0.5rem; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      animation: slideIn 0.3s ease-out; 
    }
    .notification-error { background: #ef4444; }
    .notification-success { background: #10b981; }
    @keyframes slideIn { 
      from { transform: translateX(100%); opacity: 0; } 
      to { transform: translateX(0); opacity: 1; } 
    }
  </style>
</head>
<body class="min-h-screen text-gray-100 bg-gray-900">
  <div id="notifications" class="space-y-2" aria-live="polite"></div>
  <div class="max-w-4xl mx-auto p-8">
    <h1 class="text-3xl font-bold text-center mb-6">Loja - LOGAN CC's</h1>
    <div class="flex justify-between mb-6">
      <div>
        <span id="username" class="font-semibold"></span> | Saldo: <span id="balance">0</span>
      </div>
      <button onclick="logout()" class="py-2 px-4 bg-red-600 hover:bg-red-700 rounded-md text-white">Sair</button>
    </div>
    <div id="cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"></div>
    <p id="error" class="text-red-500 text-sm hidden mt-4" role="alert"></p>
  </div>
  <button id="toggleDebug" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg" aria-label="Alternar debug">Esconder Debug</button>
  <div id="debug" aria-live="assertive"><div id="debug-output"></div></div>
  <script src="/utils.js"></script>
  <script src="/debug.js"></script>
  <script>
    async function loadUser() {
      const userId = localStorage.getItem('userId');
      const username = localStorage.getItem('username');
      if (!userId || !username) {
        Debug.error('Usuário não logado. Redirecionando para login.');
        showDebugNotification('Usuário não logado.', true);
        window.location.href = '/index.html';
        return;
      }
      try {
        const response = await fetchWithTimeout(`/api/user?userId=${userId}`, { timeout: 10000 });
        const data = await response.json();
        if (!response.ok) {
          Debug.error(`Erro ao carregar usuário: ${data.error || 'Desconhecido'}`);
          showDebugNotification(`Erro ao carregar usuário: ${data.error || 'Desconhecido'}`, true);
          window.location.href = '/index.html';
          return;
        }
        document.getElementById('username').textContent = username;
        document.getElementById('balance').textContent = data.balance.toFixed(2);
        Debug.log(`Usuário carregado: ${username}, saldo: ${data.balance}`);
      } catch (err) {
        const errorMsg = err.message.includes('timeout') 
          ? 'Timeout ao carregar usuário. Verifique a conexão com o servidor.'
          : `Erro ao carregar usuário: ${err.message}`;
        Debug.error(errorMsg);
        showDebugNotification(errorMsg, true);
        window.location.href = '/index.html';
      }
    }

    async function loadCards() {
      const userId = localStorage.getItem('userId');
      if (!userId) return;
      try {
        const response = await fetchWithTimeout(`/api/get-card-prices?userId=${userId}`, { timeout: 10000 });
        const data = await response.json();
        if (!response.ok) {
          document.getElementById('error').textContent = data.error || 'Erro ao carregar cartões';
          document.getElementById('error').classList.remove('hidden');
          Debug.error(`Erro na API: ${data.error || 'Desconhecido'}`);
          return;
        }
        const cardsDiv = document.getElementById('cards');
        cardsDiv.innerHTML = '';
        data.forEach(card => {
          const cardDiv = document.createElement('div');
          cardDiv.className = 'bg-gray-800 p-4 rounded-md';
          cardDiv.innerHTML = `
            <h3 class="text-lg font-semibold">${DOMPurify.sanitize(card.nivel)}</h3>
            <p>Preço: ${card.price.toFixed(2)}</p>
            <button onclick="buyCard('${DOMPurify.sanitize(card.nivel)}')" class="mt-2 py-1 px-3 bg-blue-600 hover:bg-blue-700 rounded-md text-white">Comprar</button>
          `;
          cardsDiv.appendChild(cardDiv);
        });
        Debug.log(`Cartões carregados: ${data.length} encontrados`);
      } catch (err) {
        const errorMsg = err.message.includes('timeout') 
          ? 'Timeout ao carregar cartões. Verifique a conexão com o servidor.'
          : `Erro ao carregar cartões: ${err.message}`;
        document.getElementById('error').textContent = errorMsg;
        document.getElementById('error').classList.remove('hidden');
        Debug.error(errorMsg);
      }
    }

    async function buyCard(nivel) {
      const userId = localStorage.getItem('userId');
      if (!userId) {
        Debug.error('Usuário não logado.');
        showDebugNotification('Usuário não logado.', true);
        window.location.href = '/index.html';
        return;
      }
      try {
        const response = await fetchWithTimeout(`/api/buy-card?userId=${userId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nivel })
        });
        const data = await response.json();
        if (!response.ok) {
          document.getElementById('error').textContent = data.error || 'Erro ao comprar cartão';
          document.getElementById('error').classList.remove('hidden');
          Debug.error(`Erro na API: ${data.error || 'Desconhecido'}`);
          return;
        }
        document.getElementById('balance').textContent = data.newBalance.toFixed(2);
        showDebugNotification('Cartão comprado com sucesso!', false);
        Debug.log(`Cartão ${nivel} comprado, novo saldo: ${data.newBalance}`);
      } catch (err) {
        const errorMsg = err.message.includes('timeout') 
          ? 'Timeout ao comprar cartão. Verifique a conexão com o servidor.'
          : `Erro ao comprar cartão: ${err.message}`;
        document.getElementById('error').textContent = errorMsg;
        document.getElementById('error').classList.remove('hidden');
        Debug.error(errorMsg);
      }
    }

    function logout() {
      localStorage.removeItem('userId');
      localStorage.removeItem('username');
      Debug.log('Usuário deslogado');
      showDebugNotification('Deslogado com sucesso!', false);
      window.location.href = '/index.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
      Debug.log('DOM carregado');
      const debugDiv = document.getElementById('debug');
      debugDiv.style.display = 'block';
      document.getElementById('toggleDebug').addEventListener('click', () => {
        debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
        document.getElementById('toggleDebug').textContent = debugDiv.style.display === 'none' ? 'Mostrar Debug' : 'Esconder Debug';
        Debug.log(`Debug ${debugDiv.style.display === 'none' ? 'desativado' : 'ativado'}`);
      });
      loadUser();
      loadCards();
      checkEnvironment();
    });
  </script>
</body>
</html>
