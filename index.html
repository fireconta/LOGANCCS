<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGAN CC's - Login</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
            opacity: 1;
            max-width: 300px;
            z-index: 1000;
        }
        #logModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow: auto;
        }
        #logModal .modal-content {
            background: #1f2937;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
        }
        #logContent {
            max-height: 400px;
            overflow-y: auto;
            background: #111827;
            padding: 1rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: #d1d5db;
        }
        #logContent .log {
            color: #d1d5db;
        }
        #logContent .error {
            color: #f87171;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">
    <!-- Div para notificações -->
    <div id="notifications" class="fixed top-4 right-4 space-y-2 z-50"></div>

    <!-- Botão LOG -->
    <button id="logButton" class="fixed top-4 left-4 p-2 bg-blue-500 hover:bg-blue-600 rounded-md font-semibold transition duration-200">LOG</button>

    <!-- Modal de Logs -->
    <div id="logModal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Logs do Sistema</h2>
            <div id="logContent"></div>
            <button id="closeLogModal" class="mt-4 p-2 bg-red-500 hover:bg-red-600 rounded-md font-semibold transition duration-200">Fechar</button>
        </div>
    </div>

    <!-- Formulário de Login -->
    <div id="loginContainer" class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md">
        <h2 class="text-2xl font-bold mb-6 text-center">Login - LOGAN CC's</h2>
        <div class="space-y-4">
            <input id="username" type="text" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Usuário" autocomplete="username">
            <input id="password" type="password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Senha" autocomplete="current-password">
            <button id="loginButton" class="w-full p-3 bg-green-500 hover:bg-green-600 rounded-md font-semibold transition duration-200">Entrar</button>
            <div id="loginError" class="text-red-500 text-sm mt-2 text-center hidden"></div>
            <p class="text-center mt-4">Não tem conta? <a id="toggleRegister" class="text-green-500 hover:underline cursor-pointer">Registre-se</a></p>
        </div>
    </div>

    <!-- Formulário de Registro -->
    <div id="registerContainer" class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md hidden">
        <h2 class="text-2xl font-bold mb-6 text-center">Registro - LOGAN CC's</h2>
        <div class="space-y-4">
            <input id="newUsername" type="text" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Usuário" autocomplete="username">
            <input id="newPassword" type="password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Senha" autocomplete="new-password">
            <input id="confirmPassword" type="password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Confirmar Senha" autocomplete="new-password">
            <button id="registerButton" class="w-full p-3 bg-green-500 hover:bg-green-600 rounded-md font-semibold transition duration-200">Registrar</button>
            <div id="registerError" class="text-red-500 text-sm mt-2 text-center hidden"></div>
            <p class="text-center mt-4">Já tem conta? <a id="toggleLogin" class="text-green-500 hover:underline cursor-pointer">Faça login</a></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>
    <!-- Configurações Globais -->
    <script src="script.js"></script>
    <!-- Script de Inicialização do Banco -->
    <script>
        // Inicializar Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDM3k33LjBRZmm9nXzLsABlxef_zaOmAKU",
            authDomain: "loganccs-b030c.firebaseapp.com",
            projectId: "loganccs-b030c",
            storageBucket: "loganccs-b030c.firebasestorage.app",
            messagingSenderId: "1022430732687",
            appId: "1:1022430732687:web:40bd56c677f7f95e6d6bfa",
            measurementId: "G-GPY8ET904E"
        };
        try {
            firebase.initializeApp(firebaseConfig);
            window.db = firebase.firestore();
            addLog('Firebase inicializado com sucesso.');

            // Script para criar e popular banco (executar uma vez)
            async function initializeDatabase() {
                try {
                    // Verificar se 'users' já tem dados
                    const usersSnapshot = await window.db.collection('users').get();
                    if (usersSnapshot.empty) {
                        const initialUsers = [
                            {
                                id: "00000000-0000-0000-0000-000000000001",
                                username: "LVz",
                                password: "123456",
                                balance: 1000.00,
                                is_admin: true,
                                created_at: "2025-06-10 13:58:23.787395+00"
                            }
                        ];
                        for (const user of initialUsers) {
                            await window.db.collection('users').doc(user.id).set({
                                username: user.username,
                                password: user.password,
                                balance: user.balance,
                                is_admin: user.is_admin,
                                created_at: user.created_at
                            });
                            addLog(`Usuário ${user.username} criado com ID ${user.id}.`);
                        }
                    } else {
                        addLog('Coleção users já existe, pulando criação.');
                    }

                    // Verificar se 'cards' já tem dados
                    const cardsSnapshot = await window.db.collection('cards').get();
                    if (cardsSnapshot.empty) {
                        const initialCards = [
                            {
                                id: "00000000-0000-0000-0000-000000000101",
                                numero: "4532015112830366",
                                cvv: "123",
                                expiry: "12/27",
                                name: "João Silva",
                                cpf: "12345678901",
                                bandeira: "Visa",
                                banco: "Nubank",
                                nivel: "Platinum",
                                price: 25.00,
                                bin: "453201",
                                acquired: false,
                                user_id: null,
                                created_at: "2025-06-10 13:58:23.787395+00"
                            },
                            {
                                id: "00000000-0000-0000-0000-000000000102",
                                numero: "5555666677778884",
                                cvv: "456",
                                expiry: "06/28",
                                name: "Maria Oliveira",
                                cpf: "98765432109",
                                bandeira: "Mastercard",
                                banco: "Itaú",
                                nivel: "Black",
                                price: 50.00,
                                bin: "555566",
                                acquired: false,
                                user_id: null,
                                created_at: "2025-06-10 13:58:23.787395+00"
                            },
                            {
                                id: "00000000-0000-0000-0000-000000000103",
                                numero: "3782822463100059",
                                cvv: "789",
                                expiry: "03/29",
                                name: "Pedro Santos",
                                cpf: "45678912345",
                                bandeira: "Amex",
                                banco: "Bradesco",
                                nivel: "Gold",
                                price: 30.00,
                                bin: "378282",
                                acquired: false,
                                user_id: null,
                                created_at: "2025-06-10 13:58:23.787395+00"
                            },
                            {
                                id: "00000000-0000-0000-0000-000000000104",
                                numero: "6362970000457013",
                                cvv: "321",
                                expiry: "09/26",
                                name: "Ana Costa",
                                cpf: "78912345678",
                                bandeira: "Elo",
                                banco: "Santander",
                                nivel: "Classic",
                                price: 10.00,
                                bin: "636297",
                                acquired: false,
                                user_id: null,
                                created_at: "2025-06-10 13:58:23.787395+00"
                            },
                            {
                                id: "00000000-0000-0000-0000-000000000105",
                                numero: "6062825624254001",
                                cvv: "654",
                                expiry: "11/28",
                                name: "Lucas Pereira",
                                cpf: "32165498712",
                                bandeira: "Hipercard",
                                banco: "Banco do Brasil",
                                nivel: "Platinum",
                                price: 20.00,
                                bin: "606282",
                                acquired: false,
                                user_id: null,
                                created_at: "2025-06-10 13:58:23.787395+00"
                            },
                            {
                                id: "00000000-0000-0000-0000-000000000106",
                                numero: "3056930902590481",
                                cvv: "987",
                                expiry: "05/30",
                                name: "Fernanda Lima",
                                cpf: "65498732145",
                                bandeira: "Diners Club",
                                banco: "Caixa Econômica Federal",
                                nivel: "Black",
                                price: 45.00,
                                bin: "305693",
                                acquired: false,
                                user_id: null,
                                created_at: "2025-06-10 13:58:23.787395+00"
                            },
                            {
                                id: "00000000-0000-0000-0000-000000000107",
                                numero: "4532731234567890",
                                cvv: "147",
                                expiry: "08/27",
                                name: "Rafael Almeida",
                                cpf: "14725836901",
                                bandeira: "Visa",
                                banco: "Sicredi",
                                nivel: "Classic",
                                price: 5.00,
                                bin: "453273",
                                acquired: false,
                                user_id: null,
                                created_at: "2025-06-10 13:58:23.787395+00"
                            },
                            {
                                id: "00000000-0000-0000-0000-000000000108",
                                numero: "5456789012345678",
                                cvv: "258",
                                expiry: "02/29",
                                name: "Camila Souza",
                                cpf: "25836914702",
                                bandeira: "Mastercard",
                                banco: "Sicoob",
                                nivel: "Gold",
                                price: 15.00,
                                bin: "545678",
                                acquired: false,
                                user_id: null,
                                created_at: "2025-06-10 13:58:23.787395+00"
                            },
                            {
                                id: "00000000-0000-0000-0000-000000000109",
                                numero: "5091234567890123",
                                cvv: "369",
                                expiry: "04/28",
                                name: "Gabriel Mendes",
                                cpf: "36914725803",
                                bandeira: "Elo",
                                banco: "Nubank",
                                nivel: "Platinum",
                                price: 35.00,
                                bin: "509123",
                                acquired: false,
                                user_id: null,
                                created_at: "2025-06-10 13:58:23.787395+00"
                            },
                            {
                                id: "00000000-0000-0000-0000-000000000110",
                                numero: "4539123456789012",
                                cvv: "741",
                                expiry: "07/29",
                                name: "Beatriz Rocha",
                                cpf: "74125836904",
                                bandeira: "Visa",
                                banco: "Itaú",
                                nivel: "Black",
                                price: 40.00,
                                bin: "453912",
                                acquired: false,
                                user_id: null,
                                created_at: "2025-06-10 13:58:23.787395+00"
                            }
                        ];
                        for (const card of initialCards) {
                            await window.db.collection('cards').doc(card.id).set({
                                numero: card.numero,
                                cvv: card.cvv,
                                expiry: card.expiry,
                                name: card.name,
                                cpf: card.cpf,
                                bandeira: card.bandeira,
                                banco: card.banco,
                                nivel: card.nivel,
                                price: card.price,
                                bin: card.bin,
                                acquired: card.acquired,
                                user_id: card.user_id,
                                created_at: card.created_at
                            });
                            addLog(`Cartão ${card.numero} criado com ID ${card.id}.`);
                        }
                    } else {
                        addLog('Coleção cards já existe, pulando criação.');
                    }

                    addLog('Banco de dados inicializado com sucesso.');
                } catch (err) {
                    addLog(`Erro ao inicializar banco: ${err.message}`, 'error');
                }
            }

            // Executar inicialização
            initializeDatabase();

            // Testar conexão
            window.db.collection('users').get().then(() => {
                addLog('Conexão com Firestore bem-sucedida.');
            }).catch(err => {
                addLog(`Erro ao conectar ao Firestore: ${err.message}`, 'error');
            });
        } catch (err) {
            addLog(`Erro ao inicializar Firebase: ${err.message}`, 'error');
        }
    </script>
    <!-- Lógica da Página -->
    <script>
        const ui = {
            showNotification(message, type = 'error') {
                addLog(`Notificação: ${message} (${type})`);
                const notificationsDiv = document.getElementById('notifications');
                if (!notificationsDiv) {
                    addLog('Div #notifications não encontrado', 'error');
                    return;
                }
                const notification = document.createElement('div');
                notification.className = `notification p-4 rounded-lg text-white shadow-lg ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
                notification.innerHTML = message;
                notificationsDiv.appendChild(notification);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, CONFIG.NOTIFICATION_DURATION_MS);
            },

            showError(context, message) {
                addLog(`Erro em ${context}: ${message}`, 'error');
                this.showNotification(message, 'error');
                const errorElement = document.getElementById(`${context}Error`);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.classList.remove('hidden');
                }
            },

            showSuccess(message) {
                addLog(`Sucesso: ${message}`);
                this.showNotification(message, 'success');
            },

            toggleLoading(buttonId, isLoading) {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = isLoading;
                    button.innerHTML = isLoading ? 'Carregando...' : (buttonId === 'loginButton' ? 'Entrar' : 'Registrar');
                }
            },

            toggleForms() {
                addLog('Alternando formulários');
                const loginContainer = document.getElementById('loginContainer');
                const registerContainer = document.getElementById('registerContainer');
                if (loginContainer && registerContainer) {
                    loginContainer.classList.toggle('hidden');
                    registerContainer.classList.toggle('hidden');
                    document.getElementById('loginError').classList.add('hidden');
                    document.getElementById('registerError').classList.add('hidden');
                } else {
                    addLog('Contêineres de login ou registro não encontrados', 'error');
                }
            },

            updateLogModal() {
                const logContent = document.getElementById('logContent');
                if (logContent) {
                    logContent.innerHTML = state.logs
                        .map(log => `<div class="${log.type}">${log.timestamp} - ${log.message}</div>`)
                        .join('');
                    logContent.scrollTop = logContent.scrollHeight;
                }
            }
        };

        const auth = {
            async login(username, password) {
                addLog(`Tentando login: ${username}`);
                if (!utils.debounce()) {
                    ui.showError('login', 'Aguarde antes de tentar novamente.');
                    return;
                }
                if (!window.db) {
                    ui.showError('login', 'Erro de conexão com o banco de dados.');
                    return;
                }
                username = utils.sanitizeInput(username);
                password = utils.sanitizeInput(password);
                if (!username || !password) {
                    ui.showError('login', 'Usuário e senha são obrigatórios.');
                    return;
                }
                ui.toggleLoading('loginButton', true);
                try {
                    const userDoc = await window.db.collection('users')
                        .where('username', '==', username)
                        .get();
                    addLog(`Resposta do Firestore: ${userDoc.size} usuário(s) encontrado(s)`);
                    if (userDoc.empty) {
                        ui.showError('login', 'Usuário ou senha inválidos.');
                        return;
                    }
                    const user = userDoc.docs[0].data();
                    if (user.password !== password) {
                        ui.showError('login', 'Senha incorreta.');
                        return;
                    }
                    state.currentUser = {
                        id: userDoc.docs[0].id,
                        username: user.username,
                        balance: user.balance || 0,
                        is_admin: user.is_admin || false
                    };
                    localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
                    localStorage.setItem('sessionStart', Date.now().toString());
                    ui.showSuccess(`Bem-vindo, ${username}!`);
                    setTimeout(() => {
                        addLog('Redirecionando para shop.html');
                        window.location.href = 'shop.html';
                    }, 1000);
                } catch (err) {
                    addLog(`Erro no login: ${err.message}`, 'error');
                    ui.showError('login', `Erro: ${err.message || 'Falha na conexão.'}`);
                } finally {
                    ui.toggleLoading('loginButton', false);
                }
            },

            async register(username, password, confirmPassword) {
                addLog(`Tentando registro: ${username}`);
                if (!utils.debounce()) {
                    ui.showError('register', 'Aguarde antes de tentar novamente.');
                    return;
                }
                if (!window.db) {
                    ui.showError('register', 'Erro de conexão com o banco de dados.');
                    return;
                }
                username = utils.sanitizeInput(username);
                password = utils.sanitizeInput(password);
                confirmPassword = utils.sanitizeInput(confirmPassword);
                if (!username || !password || !confirmPassword) {
                    ui.showError('register', 'Todos os campos são obrigatórios.');
                    return;
                }
                if (password !== confirmPassword) {
                    ui.showError('register', 'As senhas não coincidem.');
                    return;
                }
                if (username.length < 3 || !/^[a-zA-Z0-9]+$/.test(username)) {
                    ui.showError('register', 'Usuário deve ter pelo menos 3 caracteres alfanuméricos.');
                    return;
                }
                if (password.length < 6) {
                    ui.showError('register', 'Senha deve ter pelo menos 6 caracteres.');
                    return;
                }
                ui.toggleLoading('registerButton', true);
                try {
                    const userCheck = await window.db.collection('users')
                        .where('username', '==', username)
                        .get();
                    if (!userCheck.empty) {
                        ui.showError('register', 'Este usuário já existe.');
                        return;
                    }
                    const docRef = await window.db.collection('users').add({
                        username,
                        password,
                        balance: 0,
                        is_admin: false,
                        created_at: new Date().toISOString()
                    });
                    addLog(`Usuário ${username} registrado com ID ${docRef.id}.`);
                    ui.showSuccess('Conta criada com sucesso! Faça login.');
                    ui.toggleForms();
                } catch (err) {
                    addLog(`Erro no registro: ${err.message}`, 'error');
                    ui.showError('register', `Erro: ${err.message || 'Falha na conexão.'}`);
                } finally {
                    ui.toggleLoading('registerButton', false);
                }
            }
        };

        // Interceptar console.log e console.error
        const originalConsoleLog = console.log;
        console.log = function (...args) {
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            addLog(message);
            originalConsoleLog.apply(console, args);
        };

        const originalConsoleError = console.error;
        console.error = function (...args) {
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            addLog(message, 'error');
            originalConsoleError.apply(console, args);
        };

        window.onerror = function (msg, url, lineNo, columnNo, error) {
            addLog(`Erro global: ${msg}`, 'error');
            ui.showNotification(`Erro: ${msg}`, 'error');
            return false;
        };

        document.addEventListener('DOMContentLoaded', () => {
            addLog('DOM carregado');
            try {
                const logButton = document.getElementById('logButton');
                const logModal = document.getElementById('logModal');
                const closeLogModal = document.getElementById('closeLogModal');
                if (logButton && logModal && closeLogModal) {
                    logButton.addEventListener('click', () => {
                        addLog('Abrindo modal de logs');
                        ui.updateLogModal();
                        logModal.style.display = 'block';
                    });
                    closeLogModal.addEventListener('click', () => {
                        addLog('Fechando modal de logs');
                        logModal.style.display = 'none';
                    });
                    window.addEventListener('click', (event) => {
                        if (event.target === logModal) {
                            addLog('Fechando modal de logs (clique fora)');
                            logModal.style.display = 'none';
                        }
                    });
                } else {
                    addLog('Elementos do modal de logs não encontrados', 'error');
                }

                const loginButton = document.getElementById('loginButton');
                if (!loginButton) throw new Error('Botão de login não encontrado');
                loginButton.addEventListener('click', () => {
                    addLog('Botão de login clicado');
                    auth.login(
                        document.getElementById('username').value.trim(),
                        document.getElementById('password').value.trim()
                    );
                });

                const registerButton = document.getElementById('registerButton');
                if (!registerButton) throw new Error('Botão de registro não encontrado');
                registerButton.addEventListener('click', () => {
                    addLog('Botão de registro clicado');
                    auth.register(
                        document.getElementById('newUsername').value.trim(),
                        document.getElementById('newPassword').value.trim(),
                        document.getElementById('confirmPassword').value.trim()
                    );
                });

                const toggleRegister = document.getElementById('toggleRegister');
                if (!toggleRegister) throw new Error('Link de registro não encontrado');
                toggleRegister.addEventListener('click', () => {
                    addLog('Alternando para registro');
                    ui.toggleForms();
                });

                const toggleLogin = document.getElementById('toggleLogin');
                if (!toggleLogin) throw new Error('Link de login não encontrado');
                toggleLogin.addEventListener('click', () => {
                    addLog('Alternando para login');
                    ui.toggleForms();
                });
            } catch (err) {
                addLog(`Erro ao configurar eventos: ${err.message}`, 'error');
                ui.showNotification('Erro ao inicializar a interface.', 'error');
            }
        });
    </script>
</body>
</html>
