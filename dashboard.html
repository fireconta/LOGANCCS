<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOGAN CC's - Dashboard</title>
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
  <script>
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(function() {
      OneSignal.init({
        appId: "YOUR_ONESIGNAL_APP_ID"
      });
    });
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
    input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #218838; }
    .transaction { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 4px; }
    #debug { position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; max-width: 300px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>LOGAN CC's - Dashboard</h2>
    <p>Saldo: <span id="balance">Carregando...</span></p>
    <input type="number" id="depositAmount" placeholder="Valor do depósito">
    <button onclick="deposit()">Depositar</button>
    <h3>Histórico de Transações</h3>
    <div id="transactions"></div>
    <button onclick="window.location.href='shop.html'">Voltar para Loja</button>
  </div>
  <div id="debug"></div>
  <script src="script.js"></script>
  <script>
    debugLog('Iniciando dashboard...');
    document.addEventListener('DOMContentLoaded', async () => {
      debugLog('DOM carregado');
      if (!localStorage.getItem('userId')) {
        debugLog('Usuário não logado');
        window.location.href = 'index.html';
      }
      await loadBalance();
      await loadTransactions();
    });

    async function loadBalance() {
      try {
        const res = await fetch(`/api/balance?userId=${localStorage.getItem('userId')}`);
        const data = await res.json();
        if (res.status !== 200) throw new Error(data.error);
        document.getElementById('balance').textContent = formatCurrency(data.balance);
        debugLog('Saldo carregado: ' + formatCurrency(data.balance));
      } catch (err) {
        debugLog('Erro ao carregar saldo: ' + err.message);
      }
    }

    async function loadTransactions() {
      try {
        const res = await fetch(`/api/transactions?userId=${localStorage.getItem('userId')}`);
        const transactions = await res.json();
        if (res.status !== 200) throw new Error(transactions.error);
        const transactionsDiv = document.getElementById('transactions');
        transactionsDiv.innerHTML = '';
        transactions.forEach(tx => {
          const txDiv = document.createElement('div');
          txDiv.className = 'transaction';
          txDiv.innerHTML = `
            <p>${tx.description} - ${formatCurrency(tx.amount)}</p>
            <p>${new Date(tx.timestamp).toLocaleString()}</p>
          `;
          transactionsDiv.appendChild(txDiv);
        });
        debugLog('Transações carregadas: ' + transactions.length);
      } catch (err) {
        debugLog('Erro ao carregar transações: ' + err.message);
      }
    }

    async function deposit() {
      const amount = parseFloat(document.getElementById('depositAmount').value);
      if (!amount || amount <= 0) {
        debugLog('Valor de depósito inválido');
        return;
      }
      try {
        debugLog('Depositando ' + formatCurrency(amount));
        const res = await fetch('/api/deposit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: localStorage.getItem('userId'), amount })
        });
        const data = await res.json();
        if (res.status !== 200) throw new Error(data.error);
        debugLog(`Depósito de ${formatCurrency(amount)} realizado. Novo saldo: ${formatCurrency(data.newBalance)}`);
        await loadBalance();
        await loadTransactions();
      } catch (err) {
        debugLog('Erro ao depositar: ' + err.message);
      }
    }
  </script>
</body>
</html>
