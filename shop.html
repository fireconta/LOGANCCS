<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loja de Cartões - LoganCCS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/utils.js"></script>
  <script src="/debug.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .card:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
    .modal { display: none; }
    .modal.active { display: flex; }
    .brand-visa { background: linear-gradient(135deg, #1a237e, #3f51b5); }
    .brand-mastercard { background: linear-gradient(135deg, #eb001b, #f79e1b); }
    .brand-elo { background: linear-gradient(135deg, #00a1e4, #00ddeb); }
    .brand-amex { background: linear-gradient(135deg, #0077b6, #00b4d8); }
    .tab-button.active { background-color: #1a237e; color: white; }
    .buy-button { transition: background-color 0.3s ease; }
    .buy-button:hover { background-color: #1565c0; }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Navbar -->
  <nav class="bg-blue-900 text-white p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold">Loja de Cartões</h1>
    <div class="flex items-center space-x-4">
      <span id="user-info" class="text-lg"></span>
      <a href="/index.html" class="hover:underline">Logout</a>
      <a id="dashboard-link" href="/dashboard.html" class="hover:underline hidden">Dashboard</a>
    </div>
  </nav>

  <!-- Conteúdo Principal -->
  <div class="container mx-auto p-4">
    <!-- Aba Loja -->
    <div id="shop-tab" class="tab-content">
      <div class="flex flex-col md:flex-row gap-4 mb-6">
        <select id="filter-brand" class="p-2 border rounded-md">
          <option value="">Todas as Bandeiras</option>
        </select>
        <select id="filter-bank" class="p-2 border rounded-md">
          <option value="">Todos os Bancos</option>
        </select>
        <select id="filter-level" class="p-2 border rounded-md">
          <option value="">Todos os Níveis</option>
        </select>
      </div>
      <div id="cards-container" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
    </div>

    <!-- Aba Carteira -->
    <div id="wallet-tab" class="tab-content hidden">
      <div class="flex flex-col items-center mb-6">
        <img id="user-avatar" src="https://gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?s=100" alt="Avatar" class="w-24 h-24 rounded-full mb-2">
        <h2 id="user-name" class="text-xl font-bold"></h2>
        <p id="user-id" class="text-sm text-gray-600"></p>
      </div>
      <div id="purchased-cards" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>
  </div>

  <!-- Modal de Confirmação de Compra -->
  <div id="purchase-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-full max-w-md">
      <h2 class="text-2xl font-bold mb-4">Confirmar Compra</h2>
      <div id="modal-card-info" class="mb-4">
        <p><strong>Banco:</strong> <span id="modal-bank"></span></p>
        <p><strong>Bandeira:</strong> <span id="modal-brand"></span></p>
        <p><strong>Nível:</strong> <span id="modal-level"></span></p>
        <p><strong>Número:</strong> <span id="modal-card-number"></span></p>
        <p><strong>Preço:</strong> R$<span id="modal-price"></span></p>
      </div>
      <form id="purchase-form">
        <div class="mb-4">
          <label class="block text-sm font-medium">CVV</label>
          <input id="modal-cvv" type="text" class="w-full p-2 border rounded-md" oninput="restrictInput(this, 'numeric', 4)" />
        </div>
        <div class="mb-4 flex gap-4">
          <div>
            <label class="block text-sm font-medium">Mês de Expiração</label>
            <input id="modal-expiry-month" type="text" class="w-full p-2 border rounded-md" oninput="restrictInput(this, 'numeric', 2)" />
          </div>
          <div>
            <label class="block text-sm font-medium">Ano de Expiração</label>
            <input id="modal-expiry-year" type="text" class="w-full p-2 border rounded-md" oninput="restrictInput(this, 'numeric', 4)" />
          </div>
        </div>
        <div id="modal-error" class="text-red-500 text-sm mb-4 hidden"></div>
        <div class="flex justify-end gap-4">
          <button type="button" id="modal-cancel" class="px-4 py-2 bg-gray-300 rounded-md">Cancelar</button>
          <button type="submit" class="px-4 py-2 bg-blue-900 text-white rounded-md">Confirmar Compra</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Botões de Navegação -->
  <div class="fixed bottom-0 left-0 right-0 bg-white p-4 flex justify-center gap-4 border-t">
    <button id="shop-tab-button" class="tab-button px-4 py-2 rounded-md flex items-center gap-2 active">
      <i class="fas fa-store"></i> Loja
    </button>
    <button id="wallet-tab-button" class="tab-button px-4 py-2 rounded-md flex items-center gap-2">
      <i class="fas fa-wallet"></i> Carteira
    </button>
  </div>

  <!-- Rodapé -->
  <footer class="bg-blue-900 text-white p-4 text-center mt-8">
    <p>© 2025 LoganCCS. Todos os direitos reservados.</p>
  </footer>

  <script>
    debug.init('debug-panel', true);
    debug.log('Inicializando shop.html');

    // Função para formatar número do cartão
    function formatCardNumber(cardNumber) {
      return `${cardNumber.slice(0, 4)} ${cardNumber.slice(4, 6)}** **** ****`;
    }

    // Gerar ID de 9 dígitos
    function generateUserId(mongoId) {
      return (parseInt(mongoId, 16) % 1000000000).toString().padStart(9, '0');
    }

    // Verificar autenticação
    async function checkAuth() {
      try {
        const response = await fetch('/.netlify/functions/app-function/check-auth', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const data = await response.json();
        if (!data.authenticated) {
          window.location.href = '/index.html';
          return null;
        }
        document.getElementById('user-info').textContent = `Usuário: ${data.user.username} | Saldo: R$${data.user.balance}`;
        document.getElementById('user-name').textContent = data.user.username;
        document.getElementById('user-id').textContent = `ID: ${generateUserId(data.user._id)}`;
        if (data.user.isAdmin) {
          document.getElementById('dashboard-link').classList.remove('hidden');
        }
        return data.user;
      } catch (error) {
        debug.error('Erro ao verificar autenticação: ' + error.message);
        window.location.href = '/index.html';
        return null;
      }
    }

    // Carregar preços
    async function loadCardPrices() {
      try {
        const response = await fetch('/.netlify/functions/app-function/cardprices');
        const prices = await response.json();
        debug.log('Preços carregados: ' + prices.length + ' níveis');
        return prices.reduce((map, price) => {
          map[price.nivel] = price.price;
          return map;
        }, {});
      } catch (error) {
        debug.error('Erro ao carregar preços: ' + error.message);
        return {};
      }
    }

    // Carregar filtros dinâmicos
    async function loadFilters() {
      try {
        const [cardsResponse, pricesResponse] = await Promise.all([
          fetch('/.netlify/functions/app-function/cards'),
          fetch('/.netlify/functions/app-function/cardprices')
        ]);
        const cards = await cardsResponse.json();
        const prices = await pricesResponse.json();

        const filterBrand = document.getElementById('filter-brand');
        const filterBank = document.getElementById('filter-bank');
        const filterLevel = document.getElementById('filter-level');

        // Preencher filtro de bandeiras
        const brands = [...new Set(cards.map(card => card.brand))].sort();
        brands.forEach(brand => {
          const option = document.createElement('option');
          option.value = brand;
          option.textContent = brand;
          filterBrand.appendChild(option);
        });

        // Preencher filtro de bancos
        const banks = [...new Set(cards.map(card => card.bank))].sort();
        banks.forEach(bank => {
          const option = document.createElement('option');
          option.value = bank;
          option.textContent = bank;
          filterBank.appendChild(option);
        });

        // Preencher filtro de níveis
        const levels = prices.map(price => price.nivel).sort();
        levels.forEach(level => {
          const option = document.createElement('option');
          option.value = level;
          option.textContent = level;
          filterLevel.appendChild(option);
        });

        debug.log('Filtros carregados: ' + brands.length + ' bandeiras, ' + banks.length + ' bancos, ' + levels.length + ' níveis');
      } catch (error) {
        debug.error('Erro ao carregar filtros: ' + error.message);
      }
    }

    // Carregar cartões
    async function loadCards(prices) {
      try {
        const response = await fetch('/.netlify/functions/app-function/cards');
        const cards = await response.json();
        debug.log('Cartões carregados: ' + cards.length + ' encontrados');
        const container = document.getElementById('cards-container');
        const filterBrand = document.getElementById('filter-brand');
        const filterBank = document.getElementById('filter-bank');
        const filterLevel = document.getElementById('filter-level');

        // Renderizar cartões
        function renderCards() {
          const brandFilter = filterBrand.value;
          const bankFilter = filterBank.value;
          const levelFilter = filterLevel.value;
          container.innerHTML = '';
          cards.forEach(card => {
            if ((brandFilter && card.brand !== brandFilter) ||
                (bankFilter && card.bank !== bankFilter) ||
                (levelFilter && card.level !== levelFilter)) {
              return;
            }
            const cardElement = document.createElement('div');
            cardElement.className = `card bg-white p-4 rounded-lg shadow-lg brand-${card.brand.toLowerCase()}`;
            cardElement.innerHTML = DOMPurify.sanitize(`
              <div class="text-white">
                <h3 class="text-lg font-bold">${card.bank}</h3>
                <p>Bandeira: ${card.brand}</p>
                <p>Nível: ${card.level}</p>
                <p>Número: ${formatCardNumber(card.cardNumber)}</p>
                <button class="buy-button mt-4 w-full px-4 py-2 bg-blue-900 text-white rounded-md" data-card='${JSON.stringify(card)}'>Comprar por R$${prices[card.level] || 'N/A'}</button>
              </div>
            `);
            container.appendChild(cardElement);
          });
        }

        filterBrand.addEventListener('change', renderCards);
        filterBank.addEventListener('change', renderCards);
        filterLevel.addEventListener('change', renderCards);
        renderCards();
      } catch (error) {
        debug.error('Erro ao carregar cartões: ' + error.message);
      }
    }

    // Carregar cartões comprados
    async function loadPurchasedCards() {
      try {
        const response = await fetch('/.netlify/functions/app-function/purchases', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const purchases = await response.json();
        const container = document.getElementById('purchased-cards');
        container.innerHTML = '';
        purchases.forEach(purchase => {
          const card = purchase.card;
          const cardElement = document.createElement('div');
          cardElement.className = `card bg-white p-4 rounded-lg shadow-lg brand-${card.brand.toLowerCase()}`;
          cardElement.innerHTML = DOMPurify.sanitize(`
            <div class="text-white">
              <h3 class="text-lg font-bold">${card.bank}</h3>
              <p>Bandeira: ${card.brand}</p>
              <p>Nível: ${card.level}</p>
              <p>Número: ${card.cardNumber}</p>
              <p>CVV: ${card.cvv}</p>
              <p>Expiração: ${card.expiryMonth}/${card.expiryYear}</p>
              <p>Comprado em: ${new Date(purchase.purchasedAt).toLocaleString()}</p>
            </div>
          `);
          container.appendChild(cardElement);
        });
        debug.log('Cartões comprados carregados: ' + purchases.length + ' encontrados');
      } catch (error) {
        debug.error('Erro ao carregar cartões comprados: ' + error.message);
      }
    }

    // Modal de compra
    function openPurchaseModal(card, prices) {
      const modal = document.getElementById('purchase-modal');
      document.getElementById('modal-bank').textContent = card.bank;
      document.getElementById('modal-brand').textContent = card.brand;
      document.getElementById('modal-level').textContent = card.level;
      document.getElementById('modal-card-number').textContent = formatCardNumber(card.cardNumber);
      document.getElementById('modal-price').textContent = prices[card.level] || 'N/A';
      document.getElementById('modal-cvv').value = '';
      document.getElementById('modal-expiry-month').value = '';
      document.getElementById('modal-expiry-year').value = '';
      document.getElementById('modal-error').classList.add('hidden');
      modal.classList.add('active');
    }

    // Manipular compra
    async function handlePurchase(event) {
      event.preventDefault();
      const cardNumber = document.getElementById('modal-card-number').textContent.match(/\d{4}$/)[0];
      const cvv = document.getElementById('modal-cvv').value;
      const expiryMonth = document.getElementById('modal-expiry-month').value;
      const expiryYear = document.getElementById('modal-expiry-year').value;
      const level = document.getElementById('modal-level').textContent;
      const errorDiv = document.getElementById('modal-error');

      if (!cvv || !expiryMonth || !expiryYear || cvv.length < 3 || expiryMonth > 12 || expiryYear < 2025) {
        errorDiv.textContent = 'Por favor, preencha todos os campos corretamente.';
        errorDiv.classList.remove('hidden');
        return;
      }

      try {
        const response = await fetch('/.netlify/functions/app-function/purchase', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ cardNumber, cvv, expiryMonth, expiryYear, level })
        });
        const data = await response.json();
        if (data.error) {
          errorDiv.textContent = data.error;
          errorDiv.classList.remove('hidden');
        } else {
          debug.log('Compra realizada: cartão terminando em ' + cardNumber);
          document.getElementById('purchase-modal').classList.remove('active');
          alert('Compra realizada com sucesso!');
          await checkAuth();
          switchTab('wallet');
          await loadPurchasedCards();
        }
      } catch (error) {
        debug.error('Erro ao processar compra: ' + error.message);
        errorDiv.textContent = 'Erro ao processar compra.';
        errorDiv.classList.remove('hidden');
      }
    }

    // Alternar abas
    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
      document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
      document.getElementById(`${tab}-tab`).classList.remove('hidden');
      document.getElementById(`${tab}-tab-button`).classList.add('active');
      if (tab === 'wallet') {
        loadPurchasedCards();
      }
    }

    // Inicializar
    async function init() {
      const user = await checkAuth();
      if (!user) return;
      const prices = await loadCardPrices();
      await loadFilters();
      await loadCards(prices);

      // Botões de compra
      document.getElementById('cards-container').addEventListener('click', (e) => {
        if (e.target.classList.contains('buy-button')) {
          const card = JSON.parse(e.target.dataset.card);
          openPurchaseModal(card, prices);
        }
      });

      // Modal
      document.getElementById('modal-cancel').addEventListener('click', () => {
        document.getElementById('purchase-modal').classList.remove('active');
      });
      document.getElementById('purchase-form').addEventListener('submit', handlePurchase);

      // Botões de navegação
      document.getElementById('shop-tab-button').addEventListener('click', () => switchTab('shop'));
      document.getElementById('wallet-tab-button').addEventListener('click', () => switchTab('wallet'));
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
