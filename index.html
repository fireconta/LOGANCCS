<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGAN CC's - Login</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .notification {
            position: relative;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
            opacity: 1;
            max-width: 300px;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">
    <!-- Div para notificações -->
    <div id="notifications" class="fixed top-4 right-4 space-y-2 z-50"></div>

    <!-- Formulário de Login -->
    <div id="loginContainer" class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md">
        <h2 class="text-2xl font-bold mb-6 text-center">Login - LOGAN CC's</h2>
        <div class="space-y-4">
            <input id="username" type="text" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Usuário" autocomplete="username">
            <input id="password" type="password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Senha" autocomplete="current-password">
            <button id="loginButton" class="w-full p-3 bg-green-500 hover:bg-green-600 rounded-md font-semibold transition duration-200">Entrar</button>
            <div id="loginError" class="hidden text-red-500 text-sm mt-2 text-center"></div>
            <p class="text-center mt-4">Não tem conta? <a id="toggleRegister" class="text-green-500 hover:underline cursor-pointer">Registre-se</a></p>
        </div>
    </div>

    <!-- Formulário de Registro -->
    <div id="registerContainer" class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md hidden">
        <h2 class="text-2xl font-bold mb-6 text-center">Registro - LOGAN CC's</h2>
        <div class="space-y-4">
            <input id="newUsername" type="text" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Usuário" autocomplete="username">
            <input id="newPassword" type="password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Senha" autocomplete="new-password">
            <input id="confirmPassword" type="password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Confirmar Senha" autocomplete="new-password">
            <button id="registerButton" class="w-full p-3 bg-green-500 hover:bg-green-600 rounded-md font-semibold transition duration-200">Registrar</button>
            <div id="registerError" class="hidden text-red-500 text-sm mt-2 text-center"></div>
            <p class="text-center mt-4">Já tem conta? <a id="toggleLogin" class="text-green-500 hover:underline cursor-pointer">Faça login</a></p>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" integrity="sha512-6n1/EF5T+kwuZSOv0V29A3tM0zNRh0Yz2v0T2BRbEboNs0yHOeI0z7D7o4ZQmCVoex7/0zGWNUkW+YSUOxv3bNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Configurações Globais -->
    <script src="script.js"></script>
    <!-- Lógica da Página -->
    <script>
        const ui = {
            showNotification(message, type = 'error') {
                console.log('Exibindo notificação:', message, type);
                const notificationsDiv = document.getElementById('notifications');
                if (!notificationsDiv) {
                    console.error('Div #notifications não encontrada');
                    return;
                }
                const notification = document.createElement('div');
                notification.className = `notification p-4 rounded-lg text-white shadow-lg ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'}`;
                notification.innerHTML = message; // Usar innerHTML para evitar problemas com sanitização
                notificationsDiv.appendChild(notification);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, CONFIG.NOTIFICATION_DURATION_MS);
            },

            showError(context, message) {
                console.log(`Erro em ${context}:`, message);
                this.showNotification(message, 'error');
                const errorElement = document.getElementById(`${context}Error`);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.classList.remove('hidden');
                }
            },

            showSuccess(message) {
                console.log('Sucesso:', message);
                this.showNotification(message, 'success');
            },

            toggleLoading(buttonId, isLoading) {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = isLoading;
                    button.innerHTML = isLoading ? 'Carregando...' : (buttonId === 'loginButton' ? 'Entrar' : 'Registrar');
                }
            },

            toggleForms() {
                console.log('Alternando formulários');
                const loginContainer = document.getElementById('loginContainer');
                const registerContainer = document.getElementById('registerContainer');
                if (loginContainer && registerContainer) {
                    loginContainer.classList.toggle('hidden');
                    registerContainer.classList.toggle('hidden');
                    document.getElementById('loginError').classList.add('hidden');
                    document.getElementById('registerError').classList.add('hidden');
                }
            }
        };

        const auth = {
            async login(username, password) {
                console.log('Tentando login:', username);
                if (!utils.debounce()) {
                    ui.showError('login', 'Aguarde antes de tentar novamente.');
                    return;
                }
                if (!window.supabaseClient) {
                    ui.showError('login', 'Erro de conexão com o servidor.');
                    return;
                }
                username = utils.sanitizeInput(username);
                password = utils.sanitizeInput(password);
                if (!username || !password) {
                    ui.showError('login', 'Usuário e senha são obrigatórios.');
                    return;
                }
                ui.toggleLoading('loginButton', true);
                try {
                    const { data, error } = await utils.withRetry(() =>
                        window.supabaseClient.from('users').select('id, username, password, balance, is_admin').eq('username', username).single()
                    );
                    console.log('Resposta do Supabase:', { data, error });
                    if (error || !data) {
                        ui.showError('login', 'Usuário ou senha inválidos.');
                        return;
                    }
                    if (data.password !== password) {
                        ui.showError('login', 'Senha incorreta.');
                        return;
                    }
                    state.currentUser = {
                        id: data.id,
                        username: data.username,
                        balance: data.balance || 0,
                        is_admin: data.is_admin || false
                    };
                    localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
                    localStorage.setItem('sessionStart', Date.now().toString());
                    ui.showSuccess(`Bem-vindo, ${username}!`);
                    setTimeout(() => {
                        console.log('Redirecionando para shop.html');
                        window.location.href = 'shop.html';
                    }, 1000);
                } catch (err) {
                    console.error('Erro no login:', err);
                    ui.showError('login', `Erro: ${err.message || 'Falha na conexão.'}`);
                } finally {
                    ui.toggleLoading('loginButton', false);
                }
            },

            async register(username, password, confirmPassword) {
                console.log('Tentando registro:', username);
                if (!utils.debounce()) {
                    ui.showError('register', 'Aguarde antes de tentar novamente.');
                    return;
                }
                if (!window.supabaseClient) {
                    ui.showError('register', 'Erro de conexão com o servidor.');
                    return;
                }
                username = utils.sanitizeInput(username);
                password = utils.sanitizeInput(password);
                confirmPassword = utils.sanitizeInput(confirmPassword);
                if (!username || !password || !confirmPassword) {
                    ui.showError('register', 'Todos os campos são obrigatórios.');
                    return;
                }
                if (password !== confirmPassword) {
                    ui.showError('register', 'As senhas não coincidem.');
                    return;
                }
                if (username.length < 3 || !/^[a-zA-Z0-9]+$/.test(username)) {
                    ui.showError('register', 'Usuário deve ter pelo menos 3 caracteres alfanuméricos.');
                    return;
                }
                if (password.length < 6) {
                    ui.showError('register', 'Senha deve ter pelo menos 6 caracteres.');
                    return;
                }
                ui.toggleLoading('registerButton', true);
                try {
                    const { data: existingUser, error: checkError } = await utils.withRetry(() =>
                        window.supabaseClient.from('users').select('username').eq('username', username).single()
                    );
                    if (existingUser && !checkError) {
                        ui.showError('register', 'Este usuário já existe.');
                        return;
                    }
                    const { error } = await utils.withRetry(() =>
                        window.supabaseClient.from('users').insert([{ username, password, balance: 0, is_admin: false }])
                    );
                    if (error) throw error;
                    ui.showSuccess('Conta criada com sucesso! Faça login.');
                    ui.toggleForms();
                } catch (err) {
                    console.error('Erro no registro:', err);
                    ui.showError('register', `Erro: ${err.message || 'Falha na conexão.'}`);
                } finally {
                    ui.toggleLoading('registerButton', false);
                }
            }
        };

        // Interceptar erros do console
        const originalConsoleError = console.error;
        console.error = function (...args) {
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            ui.showNotification(`Erro: ${message}`, 'error');
            originalConsoleError.apply(console, args);
        };

        window.onerror = function (msg, url, lineNo, columnNo, error) {
            ui.showNotification(`Erro: ${msg}`, 'error');
            return false;
        };

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM carregado');
            try {
                const loginButton = document.getElementById('loginButton');
                if (!loginButton) throw new Error('Botão de login não encontrado');
                loginButton.addEventListener('click', () => {
                    console.log('Login clicado');
                    auth.login(
                        document.getElementById('username').value.trim(),
                        document.getElementById('password').value.trim()
                    );
                });

                const registerButton = document.getElementById('registerButton');
                if (!registerButton) throw new Error('Botão de registro não encontrado');
                registerButton.addEventListener('click', () => {
                    console.log('Registro clicado');
                    auth.register(
                        document.getElementById('newUsername').value.trim(),
                        document.getElementById('newPassword').value.trim(),
                        document.getElementById('confirmPassword').value.trim()
                    );
                });

                const toggleRegister = document.getElementById('toggleRegister');
                if (!toggleRegister) throw new Error('Link de registro não encontrado');
                toggleRegister.addEventListener('click', () => ui.toggleForms());

                const toggleLogin = document.getElementById('toggleLogin');
                if (!toggleLogin) throw new Error('Link de login não encontrado');
                toggleLogin.addEventListener('click', () => ui.toggleForms());
            } catch (err) {
                console.error('Erro ao configurar eventos:', err);
            }
        });
    </script>
</body>
</html>
