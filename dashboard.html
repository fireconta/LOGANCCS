<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š Dashboard - LoganCCS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/debug.js"></script>
  <script src="/utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/heroicons/2.0.18/dist/heroicons.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-r from-blue-100 to-gray-100 min-h-screen">
  <header class="bg-blue-800 text-white p-4 shadow sticky top-0 z-10">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">ğŸ“Š Dashboard - LoganCCS</h1>
      <nav class="flex space-x-4">
        <a href="#" onclick="logout()" class="hover:underline flex items-center" aria-label="Sair">
          <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7"></path>
          </svg>
          ğŸ”’ Logout
        </a>
        <a href="/shop" class="hover:underline flex items-center" aria-label="Ir para a Loja">
          <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18l-1.68 9H4.68L3 3zm2 14a2 2 0 100 4 2 2 0 000-4zm14 0a2 2 0 100 4 2 2 0 000-4z"></path>
          </svg>
          ğŸ›’ Loja
        </a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6">
    <!-- Abas -->
    <div class="flex space-x-4 mb-6 border-b">
      <button id="users-tab" class="px-4 py-2 font-semibold text-blue-600 border-b-2 border-blue-600 flex items-center" aria-selected="true" aria-controls="users-section">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4a4 4 0 110 8 4 4 0 010-8zm0 10c-4 0-8 2-8 5v1h16v-1c0-3-4-5-8-5z"></path>
        </svg>
        ğŸ‘¥ UsuÃ¡rios
      </button>
      <button id="cards-tab" class="px-4 py-2 font-semibold text-gray-600 hover:text-blue-600 flex items-center" aria-selected="false" aria-controls="cards-section">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 6h18M3 14h18M3 18h18"></path>
        </svg>
        ğŸ’³ CartÃµes
      </button>
      <button id="prices-tab" class="px-4 py-2 font-semibold text-gray-600 hover:text-blue-600 flex items-center" aria-selected="false" aria-controls="prices-section">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c2.21 0 4 1.79 4 4s-1.79 4-4 4-4-1.79-4-4 1.79-4 4-4zm0-6v2m0 16v2m6-6h2m-16 0H2"></path>
        </svg>
        ğŸ’° PreÃ§os
      </button>
    </div>

    <!-- Feedback -->
    <div id="feedback" class="hidden p-4 mb-4 rounded-lg text-sm"></div>

    <!-- Painel de DepuraÃ§Ã£o -->
    <div id="debug-panel" class="bg-gray-800 text-white p-4 rounded-lg mb-6">
      <h2 class="text-lg font-semibold mb-2">ğŸ“œ Painel de DepuraÃ§Ã£o</h2>
      <div id="debug-messages"></div>
    </div>

    <!-- Gerenciar UsuÃ¡rios -->
    <section id="users-section" class="bg-white p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4 flex items-center">ğŸ‘¥ Gerenciar UsuÃ¡rios</h2>
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-100">
            <th class="border p-3 text-left">ğŸ†” ID</th>
            <th class="border p-3 text-left">ğŸ‘¤ UsuÃ¡rio</th>
            <th class="border p-3 text-left">ğŸ’° Saldo</th>
            <th class="border p-3 text-left">ğŸ” Admin</th>
            <th class="border p-3 text-left">âš™ï¸ AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody id="users-table"></tbody>
      </table>
    </section>

    <!-- Gerenciar CartÃµes -->
    <section id="cards-section" class="hidden bg-white p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4 flex items-center">ğŸ’³ Gerenciar CartÃµes</h2>
      <form id="card-form" class="space-y-4">
        <div>
          <label for="card-bank" class="block text-sm font-medium text-gray-700">ğŸ¦ Banco</label>
          <select id="card-bank" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required aria-label="Selecione o banco"></select>
        </div>
        <div>
          <label for="card-brand" class="block text-sm font-medium text-gray-700">ğŸ·ï¸ Bandeira</label>
          <select id="card-brand" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required aria-label="Selecione a bandeira">
            <option value="Visa">Visa</option>
            <option value="Mastercard">Mastercard</option>
            <option value="Elo">Elo</option>
            <option value="American Express">American Express</option>
            <option value="Hipercard">Hipercard</option>
          </select>
        </div>
        <div>
          <label for="card-level" class="block text-sm font-medium text-gray-700">â­ NÃ­vel</label>
          <select id="card-level" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required aria-label="Selecione o nÃ­vel"></select>
        </div>
        <div>
          <label for="card-number" class="block text-sm font-medium text-gray-700">ğŸ”¢ NÃºmero do CartÃ£o</label>
          <input id="card-number" type="text" pattern="\d{13,19}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o nÃºmero do cartÃ£o" required aria-label="NÃºmero do cartÃ£o">
        </div>
        <div>
          <label for="card-cvv" class="block text-sm font-medium text-gray-700">ğŸ” CVV</label>
          <input id="card-cvv" type="text" pattern="\d{3,4}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o CVV" required aria-label="CVV">
        </div>
        <div class="flex space-x-4">
          <div class="w-1/2">
            <label for="card-expiry-month" class="block text-sm font-medium text-gray-700">ğŸ“… MÃªs</label>
            <input id="card-expiry-month" type="text" pattern="\d{1,2}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="MM" required aria-label="MÃªs de validade">
          </div>
          <div class="w-1/2">
            <label for="card-expiry-year" class="block text-sm font-medium text-gray-700">ğŸ“… Ano</label>
            <input id="card-expiry-year" type="text" pattern="\d{4}" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="YYYY" required aria-label="Ano de validade">
          </div>
        </div>
        <button id="card-button" type="button" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 flex items-center justify-center" aria-label="Adicionar cartÃ£o">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          âœ… Adicionar CartÃ£o
        </button>
      </form>
    </section>

    <!-- Gerenciar NÃ­veis e PreÃ§os -->
    <section id="prices-section" class="hidden bg-white p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-semibold mb-4 flex items-center">ğŸ’° Gerenciar NÃ­veis e PreÃ§os</h2>
      <form id="price-form" class="space-y-4">
        <div>
          <label for="price-level" class="block text-sm font-medium text-gray-700">â­ NÃ­vel</label>
          <input id="price-level" type="text" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o nÃ­vel" required aria-label="NÃ­vel">
        </div>
        <div>
          <label for="price-value" class="block text-sm font-medium text-gray-700">ğŸ’° PreÃ§o (R$)</label>
          <input id="price-value" type="number" step="0.01" min="0" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o preÃ§o" required aria-label="PreÃ§o">
        </div>
        <div>
          <label for="price-payment-link" class="block text-sm font-medium text-gray-700">ğŸ”— Link de Pagamento</label>
          <input id="price-payment-link" type="url" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o link de pagamento" required aria-label="Link de pagamento">
        </div>
        <button id="price-button" type="button" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 flex items-center justify-center" aria-label="Adicionar nÃ­vel">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          âœ… Adicionar NÃ­vel
        </button>
      </form>
    </section>
  </main>

  <footer class="bg-blue-800 text-white text-center p-4">
    <p>Â© 2025 LoganCCS. Todos os direitos reservados.</p>
  </footer>

  <script>
    debug.init('debug-messages', true); // Inicializa o painel de depuraÃ§Ã£o

    // Alternar abas
    const usersTab = document.getElementById('users-tab');
    const cardsTab = document.getElementById('cards-tab');
    const pricesTab = document.getElementById('prices-tab');
    const usersSection = document.getElementById('users-section');
    const cardsSection = document.getElementById('cards-section');
    const pricesSection = document.getElementById('prices-section');
    const feedback = document.getElementById('feedback');

    usersTab.addEventListener('click', () => {
      usersTab.classList.add('border-blue-600', 'text-blue-600');
      usersTab.setAttribute('aria-selected', 'true');
      cardsTab.classList.remove('border-blue-600', 'text-blue-600');
      cardsTab.setAttribute('aria-selected', 'false');
      pricesTab.classList.remove('border-blue-600', 'text-blue-600');
      pricesTab.setAttribute('aria-selected', 'false');
      usersSection.classList.remove('hidden');
      cardsSection.classList.add('hidden');
      pricesSection.classList.add('hidden');
      loadUsers();
    });

    cardsTab.addEventListener('click', () => {
      cardsTab.classList.add('border-blue-600', 'text-blue-600');
      cardsTab.setAttribute('aria-selected', 'true');
      usersTab.classList.remove('border-blue-600', 'text-blue-600');
      usersTab.setAttribute('aria-selected', 'false');
      pricesTab.classList.remove('border-blue-600', 'text-blue-600');
      pricesTab.setAttribute('aria-selected', 'false');
      cardsSection.classList.remove('hidden');
      usersSection.classList.add('hidden');
      pricesSection.classList.add('hidden');
      loadBanksAndLevels();
    });

    pricesTab.addEventListener('click', () => {
      pricesTab.classList.add('border-blue-600', 'text-blue-600');
      pricesTab.setAttribute('aria-selected', 'true');
      usersTab.classList.remove('border-blue-600', 'text-blue-600');
      usersTab.setAttribute('aria-selected', 'false');
      cardsTab.classList.remove('border-blue-600', 'text-blue-600');
      cardsTab.setAttribute('aria-selected', 'false');
      pricesSection.classList.remove('hidden');
      usersSection.classList.add('hidden');
      cardsSection.classList.add('hidden');
    });

    // Carregar bancos e nÃ­veis
    async function loadBanksAndLevels() {
      try {
        showFeedback('â³ Carregando bancos e nÃ­veis...', 'bg-blue-100 text-blue-700');
        const banksResponse = await axios.get('/api/banks', { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } });
        const levelsResponse = await axios.get('/api/cardprices', { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } });
        const bankSelect = document.getElementById('card-bank');
        const levelSelect = document.getElementById('card-level');
        bankSelect.innerHTML = '<option value="">ğŸ¦ Selecione</option>' + banksResponse.data.map(bank => `<option value="${bank._id}">${bank.name}</option>`).join('');
        levelSelect.innerHTML = '<option value="">â­ Selecione</option>' + levelsResponse.data.map(level => `<option value="${level.nivel}">${level.nivel}</option>`).join('');
        showFeedback('âœ… Bancos e nÃ­veis carregados!', 'bg-green-100 text-green-700');
      } catch (error) {
        showFeedback(`âŒ Erro ao carregar: ${error.response?.data?.error || 'Erro desconhecido'}`, 'bg-red-100 text-red-700');
        debug.error(error.response?.data?.error || 'Erro ao carregar bancos e nÃ­veis');
      }
    }

    // Carregar usuÃ¡rios
    async function loadUsers() {
      try {
        showFeedback('â³ Carregando usuÃ¡rios...', 'bg-blue-100 text-blue-700');
        const response = await axios.get('/api/users', { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } });
        const usersTable = document.getElementById('users-table');
        usersTable.innerHTML = response.data.map(user => `
          <tr class="hover:bg-gray-50">
            <td class="border p-3">ğŸ†” ${utils.generateUserId(user._id)}</td>
            <td class="border p-3">ğŸ‘¤ ${user.username}</td>
            <td class="border p-3">ğŸ’° ${user.balance}</td>
            <td class="border p-3">ğŸ” ${user.isAdmin ? 'Sim' : 'NÃ£o'}</td>
            <td class="border p-3">
              <button onclick="updateUser('${user._id}')" class="text-blue-600 hover:underline flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                âœï¸ Editar
              </button>
              <button onclick="deleteUser('${user._id}')" class="text-red-600 hover:underline flex items-center ml-2">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                ğŸ—‘ï¸ Excluir
              </button>
            </td>
          </tr>
        `).join('');
        showFeedback('âœ… UsuÃ¡rios carregados!', 'bg-green-100 text-green-700');
      } catch (error) {
        showFeedback(`âŒ Erro ao carregar usuÃ¡rios: ${error.response?.data?.error || 'Erro desconhecido'}`, 'bg-red-100 text-red-700');
        debug.error(error.response?.data?.error || 'Erro ao carregar usuÃ¡rios');
      }
    }

    // Adicionar cartÃ£o
    document.getElementById('card-button').addEventListener('click', async () => {
      const bank = document.getElementById('card-bank').value;
      const brand = document.getElementById('card-brand').value;
      const level = document.getElementById('card-level').value;
      const cardNumber = document.getElementById('card-number').value;
      const cvv = document.getElementById('card-cvv').value;
      const expiryMonth = document.getElementById('card-expiry-month').value;
      const expiryYear = document.getElementById('card-expiry-year').value;

      if (!utils.validateCardNumber(cardNumber)) {
        showFeedback('âŒ NÃºmero do cartÃ£o invÃ¡lido (13-19 dÃ­gitos)', 'bg-red-100 text-red-700');
        return;
      }
      if (!utils.validateCvv(cvv)) {
        showFeedback('âŒ CVV invÃ¡lido (3-4 dÃ­gitos)', 'bg-red-100 text-red-700');
        return;
      }
      if (!utils.validateExpiry(expiryMonth, expiryYear)) {
        showFeedback('âŒ Data de validade invÃ¡lida', 'bg-red-100 text-red-700');
        return;
      }
      if (!bank || !brand || !level) {
        showFeedback('âŒ Todos os campos sÃ£o obrigatÃ³rios', 'bg-red-100 text-red-700');
        return;
      }

      showFeedback('â³ Adicionando cartÃ£o...', 'bg-blue-100 text-blue-700');
      try {
        await axios.post('/api/cards', { bank, brand, level, cardNumber, cvv, expiryMonth, expiryYear }, { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } });
        showFeedback('âœ… CartÃ£o adicionado com sucesso!', 'bg-green-100 text-green-700');
        debug.log('CartÃ£o adicionado: ' + cardNumber);
      } catch (error) {
        showFeedback(`âŒ Erro ao adicionar cartÃ£o: ${error.response?.data?.error || 'Erro desconhecido'}`, 'bg-red-100 text-red-700');
        debug.error(error.response?.data?.error || 'Erro ao adicionar cartÃ£o');
      }
    });

    // Adicionar nÃ­vel
    document.getElementById('price-button').addEventListener('click', async () => {
      const nivel = document.getElementById('price-level').value;
      const price = parseFloat(document.getElementById('price-value').value);
      const paymentLink = document.getElementById('price-payment-link').value;

      if (!nivel || !/^[a-zA-Z0-9\s]+$/.test(nivel)) {
        showFeedback('âŒ NÃ­vel deve conter apenas letras, nÃºmeros e espaÃ§os', 'bg-red-100 text-red-700');
        return;
      }
      if (!price || price <= 0) {
        showFeedback('âŒ PreÃ§o deve ser um nÃºmero positivo', 'bg-red-100 text-red-700');
        return;
      }
      if (!utils.isValidUrl(paymentLink)) {
        showFeedback('âŒ Link de pagamento invÃ¡lido', 'bg-red-100 text-red-700');
        return;
      }

      showFeedback('â³ Adicionando nÃ­vel...', 'bg-blue-100 text-blue-700');
      try {
        await axios.post('/api/cardprices', { nivel, price, paymentLink }, { headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } });
        showFeedback('âœ… NÃ­vel adicionado com sucesso!', 'bg-green-100 text-green-700');
        debug.log('NÃ­vel adicionado: ' + nivel);
      } catch (error) {
        showFeedback(`âŒ Erro ao adicionar nÃ­vel: ${error.response?.data?.error || 'Erro desconhecido'}`, 'bg-red-100 text-red-700');
        debug.error(error.response?.data?.error || 'Erro ao adicionar nÃ­vel');
      }
    });

    // Logout
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/';
    }

    // Feedback
    function showFeedback(message, classes) {
      feedback.classList.remove('hidden');
      feedback.textContent = message;
      feedback.className = `p-4 mb-4 rounded-lg text-sm ${classes}`;
      debug.log(message);
    }

    // FunÃ§Ãµes de ediÃ§Ã£o e exclusÃ£o de usuÃ¡rio (placeholders)
    async function updateUser(userId) {
      showFeedback('âš™ï¸ Funcionalidade de ediÃ§Ã£o em desenvolvimento', 'bg-yellow-100 text-yellow-700');
    }

    async function deleteUser(userId) {
      showFeedback('â³ Excluindo usuÃ¡rio...', 'bg-blue-100 text-blue-700');
      try {
        await axios.delete('/api/delete-user', { data: { targetId: userId }, headers: { Authorization: `Bearer ${localStorage.getItem('token')}` } });
        showFeedback('âœ… UsuÃ¡rio excluÃ­do com sucesso!', 'bg-green-100 text-green-700');
        loadUsers();
      } catch (error) {
        showFeedback(`âŒ Erro ao excluir usuÃ¡rio: ${error.response?.data?.error || 'Erro desconhecido'}`, 'bg-red-100 text-red-700');
        debug.error(error.response?.data?.error || 'Erro ao excluir usuÃ¡rio');
      }
    }

    // Inicializar
    loadUsers();
  </script>
</body>
</html>
