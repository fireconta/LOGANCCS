<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGAN CC's - Login</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #globalLoader{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;visibility:hidden;z-index:9999}.spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid #10b981;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}#notifications{position:fixed;top:1rem;right:1rem;max-width:300px;z-index:10000}.notification{background:#1f2937;color:white;padding:1rem;border-radius:6px;margin-bottom:0.5rem;box-shadow:0 2px 4px rgba(0,0,0,0.2);display:flex;justify-content:space-between}.notification-error{background:#ef4444}.notification-success{background:#10b981}
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center">
    <div id="globalLoader"><div class="spinner"></div></div>
    <div id="notifications"></div>
    <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full">
        <h1 class="text-2xl font-bold text-green-500 mb-6 text-center">LOGAN CC's - Login</h1>
        <form id="loginForm" class="space-y-4">
            <div>
                <label for="username" class="block text-sm font-medium">Usuário</label>
                <input id="username" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="ex.: teste123" required pattern="[a-zA-Z0-9]{3,}" aria-describedby="usernameError">
                <p id="usernameError" class="text-red-500 text-sm hidden mt-1"></p>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium">Senha</label>
                <input type="password" id="password" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="Mín. 4 caracteres" required minlength="4" aria-describedby="passwordError">
                <p id="passwordError" class="text-red-500 text-sm hidden mt-1"></p>
            </div>
            <p id="loginError" class="text-red-500 text-sm hidden mt-2"></p>
            <div class="flex justify-end mt-4">
                <button id="loginButton" type="submit" class="py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600 flex items-center" aria-busy="false">
                    <span>Entrar</span>
                    <svg id="loginSpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"/><path fill="currentColor" d="M4 12a8 8 0 018-8v8H4z" class="opacity-75"/></svg>
                </button>
            </div>
        </form>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.9/purify.min.js" async></script>
    <script>
        const sanitizeInput = input => DOMPurify.sanitize(input, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
        const showNotification = (msg, isError = false) => {
            const n = document.createElement('div');
            n.className = `notification ${isError ? 'notification-error' : 'notification-success'}`;
            n.innerHTML = `${sanitizeInput(msg)}<button class="ml-2 text-white hover:text-gray-300"><i class="fas fa-times"></i></button>`;
            document.getElementById('notifications').appendChild(n);
            n.querySelector('button').onclick = () => n.remove();
            setTimeout(() => n.remove(), 3000);
        };
        const toggleLoader = show => document.getElementById('globalLoader').style.visibility = show ? 'visible' : 'hidden';
        const validateInput = (input, errorDiv, pattern, errorMsg) => {
            const value = input.value.trim();
            if (!value.match(pattern)) {
                errorDiv.textContent = errorMsg;
                errorDiv.classList.remove('hidden');
                return false;
            }
            errorDiv.classList.add('hidden');
            return true;
        };
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('loginForm');
            const btn = document.getElementById('loginButton');
            const spinner = document.getElementById('loginSpinner');
            const errDiv = document.getElementById('loginError');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const usernameError = document.getElementById('usernameError');
            const passwordError = document.getElementById('passwordError');

            usernameInput.addEventListener('input', () => validateInput(usernameInput, usernameError, /^[a-zA-Z0-9]{3,}$/, 'Usuário deve ter 3+ caracteres alfanuméricos.'));
            passwordInput.addEventListener('input', () => validateInput(passwordInput, passwordError, /^.{4,}$/, 'Senha deve ter 4+ caracteres.'));

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateInput(usernameInput, usernameError, /^[a-zA-Z0-9]{3,}$/, 'Usuário inválido.') ||
                    !validateInput(passwordInput, passwordError, /^.{4,}$/, 'Senha deve ter 4+ caracteres.')) {
                    return;
                }
                btn.disabled = true;
                btn.setAttribute('aria-busy', 'true');
                spinner.classList.remove('hidden');
                toggleLoader(true);
                errDiv.classList.add('hidden');
                try {
                    const username = sanitizeInput(usernameInput.value.trim());
                    const password = sanitizeInput(passwordInput.value);
                    const res = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (res.status !== 200) throw new Error(data.error);
                    localStorage.setItem('userId', data.userId);
                    localStorage.setItem('token', data.token);
                    showNotification('Login bem-sucedido!');
                    window.location.href = data.isAdmin ? 'dashboard.html' : 'shop.html';
                } catch (err) {
                    errDiv.textContent = err.message;
                    errDiv.classList.remove('hidden');
                    showNotification(`Erro: ${err.message}`, true);
                } finally {
                    btn.disabled = false;
                    btn.setAttribute('aria-busy', 'false');
                    spinner.classList.add('hidden');
                    toggleLoader(false);
                }
            });
        });
    </script>
</body>
</html>
