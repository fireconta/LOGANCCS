<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - LOGAN CC's</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" media="print" onload="this.media='all'">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.0/purify.min.js" defer></script>
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
            font-family: 'Inter', sans-serif;
        }
        body.light {
            background: #f3f4f6;
            color: #1f2937;
        }
        body.light .bg-gray-900 { background: #f3f4f6; }
        body.light .bg-gray-800 { background: #e5e7eb; }
        body.light .text-gray-100 { color: #1f2937; }
        body.light .text-gray-300 { color: #4b5563; }
        body.light .bg-gray-700 { background: #d1d5db; }
        body.light .border-gray-600 { border-color: #9ca3af; }
        #globalLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            visibility: hidden;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        body.light .spinner {
            border-color: rgba(0,0,0,0.3);
            border-top-color: #059669;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #notifications {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 10000;
            max-width: 340px;
        }
        .notification {
            background: #1f2937;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease-out;
        }
        .notification-error { background: #ef4444; }
        .notification-success { background: #10b981; }
        body.light .notification { background: #4b5563; color: white; }
        body.light .notification-error { background: #f87171; }
        body.light .notification-success { background: #34d399; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .navbar {
            backdrop-filter: blur(12px);
            background: rgba(31, 41, 55, 0.9);
        }
        body.light .navbar {
            background: rgba(243, 244, 246, 0.9);
        }
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #4b5563;
            margin-bottom: 1.5rem;
        }
        body.light .tab-buttons { border-bottom-color: #9ca3af; }
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: #9ca3af;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tab-button:hover, .tab-button.active {
            color: #10b981;
            border-bottom: 2px solid #10b981;
        }
        body.light .tab-button { color: #4b5563; }
        body.light .tab-button:hover, body.light .tab-button.active { color: #059669; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card-grid, .price-grid, .user-grid, .bank-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
        }
        .card-item, .price-item, .user-item, .bank-item {
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: linear-gradient(135deg, #374151, #1f2937);
        }
        .card-item:hover, .price-item:hover, .user-item:hover, .bank-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        body.light .card-item, body.light .price-item, body.light .user-item, body.light .bank-item {
            background: linear-gradient(135deg, #e5e7eb, #d1d5db);
            color: #1f2937;
        }
        .card-brand, .card-bank { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .card-number { font-family: monospace; letter-spacing: 2px; font-size: 0.9rem; margin-top: 0.5rem; }
        .action-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .edit-button { background: #3b82f6; }
        .edit-button:hover { background: #2563eb; }
        .delete-button { background: #ef4444; }
        .delete-button:hover { background: #dc2626; }
        .add-button {
            background: #10b981;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .add-button:hover { background: #059669; }
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            background: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        body.light .filter-section { background: #e5e7eb; }
        .filter-section select, .filter-section input {
            min-width: 160px;
            padding: 0.5rem;
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 0.25rem;
            color: white;
            transition: border-color 0.2s;
        }
        body.light .filter-section select, body.light .filter-section input {
            background: #d1d5db;
            color: #1f2937;
            border-color: #9ca3af;
        }
        .filter-section select:focus, .filter-section input:focus {
            border-color: #10b981;
            outline: none;
        }
        .no-results {
            text-align: center;
            padding: 2rem;
            background: #1f2937;
            border-radius: 0.5rem;
            color: #f59e0b;
        }
        body.light .no-results { background: #e5e7eb; color: #b45309; }
        .brand-icon, .bank-icon { font-size: 1.25rem; }
        .filter-icon { margin-right: 0.5rem; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #1f2937;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        body.light .modal-content { background: #e5e7eb; color: #1f2937; }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 0.25rem;
            color: white;
        }
        body.light .modal-content input, body.light .modal-content select {
            background: #d1d5db;
            color: #1f2937;
            border-color: #9ca3af;
        }
        .modal-content input:focus, .modal-content select:focus {
            border-color: #10b981;
            outline: none;
        }
        #serverStatus {
            position: fixed;
            top: 4.5rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            z-index: 1000;
            max-width: 340px;
            background: #ef4444;
            color: white;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        body.light #serverStatus { background: #f87171; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div id="globalLoader" aria-hidden="true"><div class="spinner"></div></div>
    <div id="notifications" class="space-y-2" aria-live="polite"></div>
    <div id="serverStatus" aria-live="assertive"></div>
    <nav class="navbar sticky top-0 z-50 p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-green-500 flex items-center">
            <i class="fas fa-tachometer-alt mr-2" aria-hidden="true"></i> LOGAN CC's - Painel Admin
        </h1>
        <div class="flex items-center space-x-4">
            <span id="usernameDisplay" class="text-gray-300 hover:text-green-500 flex items-center" aria-live="polite">
                <i class="fas fa-user mr-2"></i> Carregando...
            </span>
            <a href="/shop.html" class="text-gray-300 hover:text-green-500 flex items-center" aria-label="Ir para a Loja">
                <i class="fas fa-store mr-1"></i> Loja
            </a>
            <button id="logoutButton" class="text-gray-300 hover:text-green-500 flex items-center" aria-label="Sair do sistema">
                <i class="fas fa-sign-out-alt mr-1"></i> Sair
            </button>
            <button id="themeToggle" class="text-gray-300 hover:text-green-500" aria-label="Alternar tema claro/escuro">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </nav>
    <main class="container mx-auto p-6">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="cards"><i class="fas fa-credit-card"></i> Cartões</button>
            <button class="tab-button" data-tab="prices"><i class="fas fa-tags"></i> Preços</button>
            <button class="tab-button" data-tab="users"><i class="fas fa-users"></i> Usuários</button>
            <button class="tab-button" data-tab="banks"><i class="fas fa-university"></i> Bancos</button>
        </div>
        <section id="cards" class="tab-content active">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold flex items-center"><i class="fas fa-credit-card mr-2"></i> Gerenciar Cartões</h2>
                <button class="add-button" onclick="openAddCardModal()" aria-label="Adicionar novo cartão"><i class="fas fa-plus"></i> Adicionar Cartão</button>
            </div>
            <div class="filter-section">
                <div class="relative">
                    <i class="fas fa-search filter-icon absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="cardSearch" class="pl-10 p-2 bg-gray-700 border-b border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="Buscar por nível ou número" oninput="debounceFilterCards(this.value)" aria-label="Buscar cartões por nível ou número">
                </div>
                <div class="relative">
                    <i class="fas fa-filter filter-icon absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <select id="cardLevelFilter" class="pl-10 p-2 bg-gray-700 border-b border-gray-600 rounded focus:ring-green-500 focus:border-green-500" onchange="applyCardFilters()" aria-label="Filtrar cartões por nível">
                        <option value="">Todos os Níveis</option>
                    </select>
                </div>
                <div class="relative">
                    <i class="fas fa-credit-card filter-icon absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <select id="cardBrandFilter" class="pl-10 p-2 bg-gray-700 border-b border-gray-600 rounded focus:ring-green-500 focus:border-green-500" onchange="applyCardFilters()" aria-label="Filtrar cartões por bandeira">
                        <option value="">Todas as Bandeiras</option>
                    </select>
                </div>
                <div class="relative">
                    <i class="fas fa-university filter-icon absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <select id="cardBankFilter" class="pl-10 p-2 bg-gray-700 border-b border-gray-600 rounded focus:ring-green-500 focus:border-green-500" onchange="applyCardFilters()" aria-label="Filtrar cartões por banco">
                        <option value="">Todos os Bancos</option>
                    </select>
                </div>
                <button onclick="clearCardFilters()" class="py-2 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center" aria-label="Limpar filtros de cartões">
                    <i class="fas fa-times mr-2"></i> Limpar Filtros
                </button>
            </div>
            <div id="cardsGrid" class="card-grid" aria-live="polite"></div>
        </section>
        <section id="prices" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold flex items-center"><i class="fas fa-tags mr-2"></i> Gerenciar Preços</h2>
                <button class="add-button" onclick="openAddPriceModal()" aria-label="Adicionar novo preço"><i class="fas fa-plus"></i> Adicionar Preço</button>
            </div>
            <div class="filter-section">
                <div class="relative">
                    <i class="fas fa-search filter-icon absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="priceSearch" class="pl-10 p-2 bg-gray-700 border-b border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="Buscar por nível" oninput="debounceFilterPrices(this.value)" aria-label="Buscar preços por nível">
                </div>
                <button onclick="clearPriceFilters()" class="py-2 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center" aria-label="Limpar filtros de preços">
                    <i class="fas fa-times mr-2"></i> Limpar Filtros
                </button>
            </div>
            <div id="pricesGrid" class="price-grid" aria-live="polite"></div>
        </section>
        <section id="users" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold flex items-center"><i class="fas fa-users mr-2"></i> Gerenciar Usuários</h2>
                <button class="add-button" onclick="openAddUserModal()" aria-label="Adicionar novo usuário"><i class="fas fa-plus"></i> Adicionar Usuário</button>
            </div>
            <div class="filter-section">
                <div class="relative">
                    <i class="fas fa-search filter-icon absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="userSearch" class="pl-10 p-2 bg-gray-700 border-b border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="Buscar por nome de usuário" oninput="debounceFilterUsers(this.value)" aria-label="Buscar usuários por nome">
                </div>
                <button onclick="clearUserFilters()" class="py-2 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center" aria-label="Limpar filtros de usuários">
                    <i class="fas fa-times mr-2"></i> Limpar Filtros
                </button>
            </div>
            <div id="usersGrid" class="user-grid" aria-live="polite"></div>
        </section>
        <section id="banks" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold flex items-center"><i class="fas fa-university mr-2"></i> Gerenciar Bancos</h2>
                <button class="add-button" onclick="openAddBankModal()" aria-label="Adicionar novo banco"><i class="fas fa-plus"></i> Adicionar Banco</button>
            </div>
            <div class="filter-section">
                <div class="relative">
                    <i class="fas fa-search filter-icon absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="bankSearch" class="pl-10 p-2 bg-gray-700 border-b border-gray-600 rounded focus:ring-green-500 focus:border-green-500" placeholder="Buscar por nome do banco" oninput="debounceFilterBanks(this.value)" aria-label="Buscar bancos por nome">
                </div>
                <button onclick="clearBankFilters()" class="py-2 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center" aria-label="Limpar filtros de bancos">
                    <i class="fas fa-times mr-2"></i> Limpar Filtros
                </button>
            </div>
            <div id="banksGrid" class="bank-grid" aria-live="polite"></div>
        </section>
        <div id="addCardModal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4">Adicionar Cartão</h3>
                <select id="cardNivel" aria-label="Nível do cartão" required>
                    <option value="">Selecione o Nível</option>
                </select>
                <input type="text" id="cardNumero" placeholder="Número (16 dígitos)" aria-label="Número do cartão" required>
                <input type="text" id="cardDataValidade" placeholder="Validade (MM/AA)" aria-label="Data de validade" required>
                <input type="text" id="cardCvv" placeholder="CVV (3-4 dígitos)" aria-label="CVV do cartão" required>
                <input type="text" id="cardBin" placeholder="BIN (6 dígitos)" aria-label="BIN do cartão" required>
                <select id="cardBandeira" aria-label="Bandeira do cartão" required>
                    <option value="">Selecione a Bandeira</option>
                </select>
                <select id="cardBanco" aria-label="Banco do cartão" required>
                    <option value="">Selecione o Banco</option>
                </select>
                <div class="flex justify-end gap-2">
                    <button class="action-button delete-button" onclick="closeAddCardModal()" aria-label="Cancelar adição de cartão">Cancelar</button>
                    <button class="action-button add-button" onclick="addCard()" aria-label="Adicionar cartão">Adicionar</button>
                </div>
            </div>
        </div>
        <div id="editCardModal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4">Editar Cartão</h3>
                <input type="hidden" id="editCardId">
                <select id="editCardNivel" aria-label="Nível do cartão" required>
                    <option value="">Selecione o Nível</option>
                </select>
                <input type="text" id="editCardNumero" placeholder="Número (16 dígitos)" aria-label="Número do cartão" required>
                <input type="text" id="editCardDataValidade" placeholder="Validade (MM/AA)" aria-label="Data de validade" required>
                <input type="text" id="editCardCvv" placeholder="CVV (3-4 dígitos)" aria-label="CVV do cartão" required>
                <input type="text" id="editCardBin" placeholder="BIN (6 dígitos)" aria-label="BIN do cartão" required>
                <select id="editCardBandeira" aria-label="Bandeira do cartão" required>
                    <option value="">Selecione a Bandeira</option>
                </select>
                <select id="editCardBanco" aria-label="Banco do cartão" required>
                    <option value="">Selecione o Banco</option>
                </select>
                <div class="flex justify-end gap-2">
                    <button class="action-button delete-button" onclick="closeEditCardModal()" aria-label="Cancelar edição de cartão">Cancelar</button>
                    <button class="action-button add-button" onclick="updateCard()" aria-label="Salvar alterações do cartão">Salvar</button>
                </div>
            </div>
        </div>
        <div id="addPriceModal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4">Adicionar Preço</h3>
                <input type="text" id="priceNivel" placeholder="Nível (ex.: Classic)" aria-label="Nível do preço" required>
                <input type="number" id="priceValor" placeholder="Preço (ex.: 500)" step="0.01" min="0" aria-label="Preço" required>
                <div class="flex justify-end gap-2">
                    <button class="action-button delete-button" onclick="closeAddPriceModal()" aria-label="Cancelar adição de preço">Cancelar</button>
                    <button class="action-button add-button" onclick="addPrice()" aria-label="Adicionar preço">Adicionar</button>
                </div>
            </div>
        </div>
        <div id="editPriceModal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4">Editar Preço</h3>
                <input type="hidden" id="editPriceId">
                <input type="text" id="editPriceNivel" placeholder="Nível (ex.: Classic)" aria-label="Nível do preço" required>
                <input type="number" id="editPriceValor" placeholder="Preço (ex.: 500)" step="0.01" min="0" aria-label="Preço" required>
                <div class="flex justify-end gap-2">
                    <button class="action-button delete-button" onclick="closeEditPriceModal()" aria-label="Cancelar edição de preço">Cancelar</button>
                    <button class="action-button add-button" onclick="updatePrice()" aria-label="Salvar alterações do preço">Salvar</button>
                </div>
            </div>
        </div>
        <div id="addUserModal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4">Adicionar Usuário</h3>
                <input type="text" id="userUsername" placeholder="Nome de usuário" aria-label="Nome de usuário" required>
                <input type="password" id="userPassword" placeholder="Senha" aria-label="Senha" required>
                <input type="number" id="userBalance" placeholder="Saldo inicial" step="0.01" min="0" aria-label="Saldo inicial" required>
                <select id="userIsAdmin" aria-label="Tipo de usuário" required>
                    <option value="false">Usuário Comum</option>
                    <option value="true">Administrador</option>
                </select>
                <div class="flex justify-end gap-2">
                    <button class="action-button delete-button" onclick="closeAddUserModal()" aria-label="Cancelar adição de usuário">Cancelar</button>
                    <button class="action-button add-button" onclick="addUser()" aria-label="Adicionar usuário">Adicionar</button>
                </div>
            </div>
        </div>
        <div id="editUserModal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4">Editar Usuário</h3>
                <input type="hidden" id="editUserId">
                <input type="text" id="editUserUsername" placeholder="Nome de usuário" aria-label="Nome de usuário" required>
                <input type="number" id="editUserBalance" placeholder="Saldo" step="0.01" min="0" aria-label="Saldo" required>
                <select id="editUserIsAdmin" aria-label="Tipo de usuário" required>
                    <option value="false">Usuário Comum</option>
                    <option value="true">Administrador</option>
                </select>
                <div class="flex justify-end gap-2">
                    <button class="action-button delete-button" onclick="closeEditUserModal()" aria-label="Cancelar edição de usuário">Cancelar</button>
                    <button class="action-button add-button" onclick="updateUser()" aria-label="Salvar alterações do usuário">Salvar</button>
                </div>
            </div>
        </div>
        <div id="addBankModal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4">Adicionar Banco</h3>
                <input type="text" id="bankName" placeholder="Nome do banco (ex.: Banco do Brasil)" aria-label="Nome do banco" required>
                <select id="bankType" aria-label="Tipo de banco" required>
                    <option value="">Selecione o Tipo</option>
                    <option value="Estatal">Estatal</option>
                    <option value="Privado">Privado</option>
                    <option value="Estrangeiro">Estrangeiro</option>
                    <option value="Neobanco">Neobanco</option>
                </select>
                <div class="flex justify-end gap-2">
                    <button class="action-button delete-button" onclick="closeAddBankModal()" aria-label="Cancelar adição de banco">Cancelar</button>
                    <button class="action-button add-button" onclick="addBank()" aria-label="Adicionar banco">Adicionar</button>
                </div>
            </div>
        </div>
        <div id="editBankModal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4">Editar Banco</h3>
                <input type="hidden" id="editBankId">
                <input type="text" id="editBankName" placeholder="Nome do banco (ex.: Banco do Brasil)" aria-label="Nome do banco" required>
                <select id="editBankType" aria-label="Tipo de banco" required>
                    <option value="">Selecione o Tipo</option>
                    <option value="Estatal">Estatal</option>
                    <option value="Privado">Privado</option>
                    <option value="Estrangeiro">Estrangeiro</option>
                    <option value="Neobanco">Neobanco</option>
                </select>
                <div class="flex justify-end gap-2">
                    <button class="action-button delete-button" onclick="closeEditBankModal()" aria-label="Cancelar edição de banco">Cancelar</button>
                    <button class="action-button add-button" onclick="updateBank()" aria-label="Salvar alterações do banco">Salvar</button>
                </div>
            </div>
        </div>
    </main>
    <script>
        const isDevMode = typeof process !== 'undefined' && process.env.NODE_ENV !== 'production';

        async function fetchWithTimeout(url, options, timeout = 15000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const startTime = performance.now();
            try {
                const response = await fetch(url, { ...options, signal: controller.signal });
                const endTime = performance.now();
                clearTimeout(id);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Erro HTTP ${response.status}`);
                }
                if (isDevMode) {
                    console.log(`[API] ${url} - Sucesso | Tempo: ${(endTime - startTime).toFixed(2)}ms | Status: ${response.status}`);
                }
                return response;
            } catch (error) {
                const endTime = performance.now();
                clearTimeout(id);
                if (isDevMode) {
                    console.error(`[API] ${url} - Falha | Tempo: ${(endTime - startTime).toFixed(2)}ms | Erro: ${error.message}`);
                }
                if (error.name === 'AbortError') {
                    throw new Error('Tempo de resposta do servidor excedido. Tente novamente.');
                }
                throw error;
            }
        }

        async function checkServerStatus() {
            const serverStatus = document.getElementById('serverStatus');
            try {
                if (isDevMode) console.log('[DEBUG] Verificando status do servidor e APIs...');
                const envResponse = await fetchWithTimeout('/api/check-env', {}, 15000);
                const envData = await envResponse.json();
                if (!envData.mongodbConnected) {
                    if (isDevMode) console.error('[DEBUG] MongoDB não conectado');
                    serverStatus.style.display = 'block';
                    serverStatus.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i> MongoDB não conectado.';
                    return false;
                }
                if (!envData.collections?.cards?.exists || !envData.collections?.cardPrices?.exists || 
                    !envData.collections?.users?.exists || !envData.collections?.banks?.exists) {
                    if (isDevMode) {
                        console.error('[DEBUG] Coleções ausentes:', {
                            cards: envData.collections?.cards?.exists,
                            cardPrices: envData.collections?.cardPrices?.exists,
                            users: envData.collections?.users?.exists,
                            banks: envData.collections?.banks?.exists
                        });
                    }
                    serverStatus.style.display = 'block';
                    serverStatus.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i> Coleções do banco de dados ausentes.';
                    return false;
                }
                if (isDevMode) {
                    console.log('[DEBUG] MongoDB conectado com sucesso');
                    console.log('[DEBUG] Coleções verificadas:', {
                        cards: envData.collections.cards.exists,
                        cardPrices: envData.collections.cardPrices.exists,
                        users: envData.collections.users.exists,
                        banks: envData.collections.banks.exists
                    });
                }

                const apiEndpoints = [
                    '/api/get-cards?userId=test',
                    '/api/get-card-prices?userId=test',
                    '/api/get-users?userId=test',
                    '/api/get-banks?userId=test'
                ];
                const apiChecks = await Promise.allSettled(apiEndpoints.map(url => 
                    fetchWithTimeout(url, {}, 15000).then(res => res.json())
                ));
                const failedApis = apiChecks.filter(check => check.status === 'rejected');
                if (failedApis.length > 0) {
                    if (isDevMode) console.error('[DEBUG] APIs com falha:', failedApis);
                    serverStatus.style.display = 'block';
                    serverStatus.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> Algumas APIs estão indisponíveis.`;
                    return false;
                }
                if (isDevMode) console.log('[DEBUG] Todas as APIs estão funcionando corretamente');
                serverStatus.style.display = 'none';
                return true;
            } catch (err) {
                if (isDevMode) console.error('[DEBUG] Erro ao verificar status do servidor:', err);
                serverStatus.style.display = 'block';
                serverStatus.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i> Erro ao verificar servidor: ${DOMPurify.sanitize(err.message)}`;
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.classList.add('light');
                document.getElementById('themeToggle').innerHTML = `<i class="fas fa-sun"></i>`;
            }
            if (!(await checkServerStatus())) {
                showNotification('Servidor ou banco de dados indisponível. Tente novamente mais tarde.', true);
                return;
            }
            if (!(await checkAuth())) {
                return;
            }
            await loadCards();
        });
    </script>
    <script src="/functions/app-function.js"></script>
</body>
</html>
