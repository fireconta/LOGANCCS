<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOGAN CC's - Loja</title>
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
  <script>
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(function() {
      OneSignal.init({
        appId: "YOUR_ONESIGNAL_APP_ID"
      });
    });
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
    .card { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 4px; }
    button { padding: 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #218838; }
    #debug { position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; max-width: 300px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>LOGAN CC's - Loja</h2>
    <p>Saldo: <span id="balance">Carregando...</span></p>
    <div id="cards"></div>
    <button onclick="window.location.href='dashboard.html'">Ir para Dashboard</button>
  </div>
  <div id="debug"></div>
  <script src="script.js"></script>
  <script>
    debugLog('Iniciando loja...');
    document.addEventListener('DOMContentLoaded', async () => {
      debugLog('DOM carregado');
      if (!localStorage.getItem('userId')) {
        debugLog('Usuário não logado');
        window.location.href = 'index.html';
      }
      await loadBalance();
      await loadCards();
    });

    async function loadBalance() {
      try {
        const res = await fetch(`/api/balance?userId=${localStorage.getItem('userId')}`);
        const data = await res.json();
        if (res.status !== 200) throw new Error(data.error);
        document.getElementById('balance').textContent = formatCurrency(data.balance);
        debugLog('Saldo carregado: ' + formatCurrency(data.balance));
      } catch (err) {
        debugLog('Erro ao carregar saldo: ' + err.message);
      }
    }

    async function loadCards() {
      try {
        const res = await fetch('/api/cards');
        const cards = await res.json();
        if (res.status !== 200) throw new Error(cards.error);
        const cardsDiv = document.getElementById('cards');
        cardsDiv.innerHTML = '';
        cards.forEach(card => {
          const cardDiv = document.createElement('div');
          cardDiv.className = 'card';
          cardDiv.innerHTML = `
            <p>Cartão ${card.bandeira} ${card.nivel} - ${formatCurrency(card.price)}</p>
            <p>Banco: ${card.banco}</p>
            <button onclick="buyCard('${card._id}', ${card.price})">Comprar</button>
          `;
          cardsDiv.appendChild(cardDiv);
        });
        debugLog('Cartões carregados: ' + cards.length);
      } catch (err) {
        debugLog('Erro ao carregar cartões: ' + err.message);
      }
    }

    async function buyCard(cardId, price) {
      try {
        debugLog('Comprando cartão ' + cardId);
        const res = await fetch('/api/buy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: localStorage.getItem('userId'), cardId, price })
        });
        const data = await res.json();
        if (res.status !== 200) throw new Error(data.error);
        debugLog(`Cartão ${cardId} comprado. Novo saldo: ${formatCurrency(data.newBalance)}`);
        await loadBalance();
        await loadCards();
      } catch (err) {
        debugLog('Erro ao comprar: ' + err.message);
      }
    }
  </script>
</body>
</html>
