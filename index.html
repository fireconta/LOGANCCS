<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGAN CC's - Login</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
            opacity: 1;
            max-width: 300px;
            z-index: 1000;
        }
        #logModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow: auto;
        }
        #logModal .modal-content {
            background: #1f2937;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
        }
        #logContent {
            max-height: 400px;
            overflow-y: auto;
            background: #111827;
            padding: 1rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: #d1d5db;
        }
        #logContent .log {
            color: #d1d5db;
        }
        #logContent .error {
            color: #f87171;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">
    <!-- Div para notificações -->
    <div id="notifications" class="fixed top-4 right-4 space-y-2 z-50"></div>

    <!-- Botão LOG -->
    <button id="logButton" class="fixed top-4 left-4 p-2 bg-blue-500 hover:bg-blue-600 rounded-md font-semibold transition duration-200">LOG</button>

    <!-- Modal de Logs -->
    <div id="logModal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Logs do Sistema</h2>
            <div id="logContent"></div>
            <button id="closeLogModal" class="mt-4 p-2 bg-red-500 hover:bg-red-600 rounded-md font-semibold transition duration-200">Fechar</button>
        </div>
    </div>

    <!-- Formulário de Login -->
    <div id="loginContainer" class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md">
        <h2 class="text-2xl font-bold mb-6 text-center">Login - LOGAN CC's</h2>
        <div class="space-y-4">
            <input id="username" type="text" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Usuário" autocomplete="username">
            <input id="password" type="password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Senha" autocomplete="current-password">
            <button id="loginButton" class="w-full p-3 bg-green-500 hover:bg-green-600 rounded-md font-semibold transition duration-200">Entrar</button>
            <div id="loginError" class="text-red-500 text-sm mt-2 text-center hidden"></div>
            <p class="text-center mt-4">Não tem conta? <a id="toggleRegister" class="text-green-500 hover:underline cursor-pointer">Registre-se</a></p>
        </div>
    </div>

    <!-- Formulário de Registro -->
    <div id="registerContainer" class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md hidden">
        <h2 class="text-2xl font-bold mb-6 text-center">Registro - LOGAN CC's</h2>
        <div class="space-y-4">
            <input id="newUsername" type="text" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Usuário" autocomplete="username">
            <input id="newPassword" type="password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Senha" autocomplete="new-password">
            <input id="confirmPassword" type="password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Confirmar Senha" autocomplete="new-password">
            <button id="registerButton" class="w-full p-3 bg-green-500 hover:bg-green-600 rounded-md font-semibold transition duration-200">Registrar</button>
            <div id="registerError" class="text-red-500 text-sm mt-2 text-center hidden"></div>
            <p class="text-center mt-4">Já tem conta? <a id="toggleLogin" class="text-green-500 hover:underline cursor-pointer">Faça login</a></p>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>
    <!-- Configurações Globais -->
    <script src="script.js"></script>
    <!-- Lógica da Página -->
    <script>
        const ui = {
            showNotification(message, type = 'error') {
                addLog(`Notificação: ${message} (${type})`);
                const notificationsDiv = document.getElementById('notifications');
                if (!notificationsDiv) {
                    addLog('Div #notifications não encontrada', 'error');
                    return;
                }
                const notification = document.createElement('div');
                notification.className = `notification p-4 rounded-lg text-white shadow-lg ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
                notification.innerHTML = message;
                notificationsDiv.appendChild(notification);
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, CONFIG.NOTIFICATION_DURATION_MS);
            },

            showError(context, message) {
                addLog(`Erro em ${context}: ${message}`, 'error');
                this.showNotification(message, 'error');
                const errorElement = document.getElementById(`${context}Error`);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.classList.remove('hidden');
                }
            },

            showSuccess(message) {
                addLog(`Sucesso: ${message}`);
                this.showNotification(message, 'success');
            },

            toggleLoading(buttonId, isLoading) {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = isLoading;
                    button.innerHTML = isLoading ? 'Carregando...' : (buttonId === 'loginButton' ? 'Entrar' : 'Registrar');
                }
            },

            toggleForms() {
                addLog('Alternando formulários');
                const loginContainer = document.getElementById('loginContainer');
                const registerContainer = document.getElementById('registerContainer');
                if (loginContainer && registerContainer) {
                    loginContainer.classList.toggle('hidden');
                    registerContainer.classList.toggle('hidden');
                    document.getElementById('loginError').classList.add('hidden');
                    document.getElementById('registerError').classList.add('hidden');
                } else {
                    addLog('Contêineres de login ou registro não encontrados', 'error');
                }
            },

            updateLogModal() {
                const logContent = document.getElementById('logContent');
                if (logContent) {
                    logContent.innerHTML = state.logs
                        .map(log => `<div class="${log.type}">${log.timestamp} - ${log.message}</div>`)
                        .join('');
                    logContent.scrollTop = logContent.scrollHeight;
                }
            }
        };

        const auth = {
            async login(username, password) {
                addLog(`Tentando login: ${username}`);
                if (!utils.debounce()) {
                    ui.showError('login', 'Aguarde antes de tentar novamente.');
                    return;
                }
                if (!window.supabaseClient) {
                    ui.showError('login', 'Erro de conexão com o servidor. Verifique sua conexão.');
                    return;
                }
                username = utils.sanitizeInput(username);
                password = utils.sanitizeInput(password);
                if (!username || !password) {
                    ui.showError('login', 'Usuário e senha são obrigatórios.');
                    return;
                }
                ui.toggleLoading('loginButton', true);
                try {
                    const { data, error } = await utils.withRetry(() =>
                        window.supabaseClient.from('users').select('id, username, password, balance, is_admin').eq('username', username).single()
                    );
                    addLog(`Resposta do Supabase: ${JSON.stringify({ data, error })}`);
                    if (error) {
                        throw error;
                    }
                    if (!data) {
                        ui.showError('login', 'Usuário ou senha inválidos.');
                        return;
                    }
                    if (data.password !== password) {
                        ui.showError('login', 'Senha incorreta.');
                        return;
                    }
                    state.currentUser = {
                        id: data.id,
                        username: data.username,
                        balance: data.balance || 0,
                        is_admin: data.is_admin || false
                    };
                    localStorage.setItem('currentUser', JSON.stringify(state.currentUser));
                    localStorage.setItem('sessionStart', Date.now().toString());
                    ui.showSuccess(`Bem-vindo, ${username}!`);
                    setTimeout(() => {
                        addLog('Redirecionando para shop.html');
                        window.location.href = 'shop.html';
                    }, 1000);
                } catch (err) {
                    addLog(`Erro no login: ${err.message}`, 'error');
                    ui.showError('login', `Erro: ${err.message || 'Falha na conexão com o servidor.'}`);
                } finally {
                    ui.toggleLoading('loginButton', false);
                }
            },

            async register(username, password, confirmPassword) {
                addLog(`Tentando registro: ${username}`);
                if (!utils.debounce()) {
                    ui.showError('register', 'Aguarde antes de tentar novamente.');
                    return;
                }
                if (!window.supabaseClient) {
                    ui.showError('register', 'Erro de conexão com o servidor.');
                    return;
                }
                username = utils.sanitizeInput(username);
                password = utils.sanitizeInput(password);
                confirmPassword = utils.sanitizeInput(confirmPassword);
                if (!username || !password || !confirmPassword) {
                    ui.showError('register', 'Todos os campos são obrigatórios.');
                    return;
                }
                if (password !== confirmPassword) {
                    ui.showError('register', 'As senhas não coincidem.');
                    return;
                }
                if (username.length < 3 || !/^[a-zA-Z0-9]+$/.test(username)) {
                    ui.showError('register', 'Usuário deve ter pelo menos 3 caracteres alfanuméricos.');
                    return;
                }
                if (password.length < 6) {
                    ui.showError('register', 'Senha deve ter pelo menos 6 caracteres.');
                    return;
                }
                ui.toggleLoading('registerButton', true);
                try {
                    const { data: existingUser, error: checkError } = await utils.withRetry(() =>
                        window.supabaseClient.from('users').select('username').eq('username', username).single()
                    );
                    if (existingUser && !checkError) {
                        ui.showError('register', 'Este usuário já existe.');
                        return;
                    }
                    const { error } = await utils.withRetry(() =>
                        window.supabaseClient.from('users').insert([{ username, password, balance: 0, is_admin: false }])
                    );
                    if (error) throw error;
                    ui.showSuccess('Conta criada com sucesso! Faça login.');
                    ui.toggleForms();
                } catch (err) {
                    addLog(`Erro no registro: ${err.message}`, 'error');
                    ui.showError('register', `Erro: ${err.message || 'Falha na conexão com o servidor.'}`);
                } finally {
                    ui.toggleLoading('registerButton', false);
                }
            }
        };

        // Interceptar console.log e console.error
        const originalConsoleLog = console.log;
        console.log = function (...args) {
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            addLog(message);
            originalConsoleLog.apply(console, args);
        };

        const originalConsoleError = console.error;
        console.error = function (...args) {
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            addLog(message, 'error');
            originalConsoleError.apply(console, args);
        };

        window.onerror = function (msg, url, lineNo, columnNo, error) {
            addLog(`Erro global: ${msg}`, 'error');
            ui.showNotification(`Erro: ${msg}`, 'error');
            return false;
        };

        document.addEventListener('DOMContentLoaded', () => {
            addLog('DOM carregado');
            try {
                // Configurar botão LOG
                const logButton = document.getElementById('logButton');
                const logModal = document.getElementById('logModal');
                const closeLogModal = document.getElementById('closeLogModal');
                if (logButton && logModal && closeLogModal) {
                    logButton.addEventListener('click', () => {
                        addLog('Abrindo modal de logs');
                        ui.updateLogModal();
                        logModal.style.display = 'block';
                    });
                    closeLogModal.addEventListener('click', () => {
                        addLog('Fechando modal de logs');
                        logModal.style.display = 'none';
                    });
                    window.addEventListener('click', (event) => {
                        if (event.target === logModal) {
                            addLog('Fechando modal de logs (clique fora)');
                            logModal.style.display = 'none';
                        }
                    });
                } else {
                    addLog('Elementos do modal de logs não encontrados', 'error');
                }

                const loginButton = document.getElementById('loginButton');
                if (!loginButton) throw new Error('Botão de login não encontrado');
                loginButton.addEventListener('click', () => {
                    addLog('Botão de login clicado');
                    auth.login(
                        document.getElementById('username').value.trim(),
                        document.getElementById('password').value.trim()
                    );
                });

                const registerButton = document.getElementById('registerButton');
                if (!registerButton) throw new Error('Botão de registro não encontrado');
                registerButton.addEventListener('click', () => {
                    addLog('Botão de registro clicado');
                    auth.register(
                        document.getElementById('newUsername').value.trim(),
                        document.getElementById('newPassword').value.trim(),
                        document.getElementById('confirmPassword').value.trim()
                    );
                });

                const toggleRegister = document.getElementById('toggleRegister');
                if (!toggleRegister) throw new Error('Link de registro não encontrado');
                toggleRegister.addEventListener('click', () => {
                    addLog('Alternando para registro');
                    ui.toggleForms();
                });

                const toggleLogin = document.getElementById('toggleLogin');
                if (!toggleLogin) throw new Error('Link de login não encontrado');
                toggleLogin.addEventListener('click', () => {
                    addLog('Alternando para login');
                    ui.toggleForms();
                });
            } catch (err) {
                addLog(`Erro ao configurar eventos: ${err.message}`, 'error');
                ui.showNotification('Erro ao inicializar a interface.', 'error');
            }
        });
    </script>
</body>
</html>
