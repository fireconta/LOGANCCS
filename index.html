<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - LOGANCCS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" media="print" onload="this.media='all'">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.0/purify.min.js" defer></script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        body.light { background: #f3f4f6; color: #1f2937; }
        body.light .bg-gray-900 { background: #f3f4f6; }
        body.light .bg-gray-800 { background: #e5e7eb; }
        body.light .text-gray-100 { color: #1f2937; }
        body.light .text-gray-300 { color: #4b5563; }
        #globalLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; visibility: hidden; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notifications { position: fixed; top: 1rem; right: 1rem; z-index: 10000; max-width: 320px; }
        .notification { background: #1f2937; color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; animation: slideIn 0.3s ease-out; }
        .notification-error { background: #ef4444; }
        .notification-success { background: #10b981; }
        body.light .notification { background: #4b5563; color: white; }
        body.light .notification-error { background: #f87171; }
        body.light .notification-success { background: #34d399; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        #debug { position: fixed; bottom: 4rem; left: 1rem; background: #1f2937; color: white; padding: 1rem; border-radius: 0.5rem; max-width: 400px; max-height: 300px; overflow-y: auto; z-index: 1000; font-size: 0.75rem; }
        body.light #debug { background: #e5e7eb; color: #1f2937; }
        .debug-info { color: #34d399; }
        .debug-warn { color: #f59e0b; }
        .debug-error { color: #f87171; }
        .debug-success { color: #10b981; }
        .form-container { max-width: 400px; margin: 2rem auto; }
        .form-toggle { cursor: pointer; color: #10b981; }
        .form-toggle:hover { text-decoration: underline; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div id="globalLoader" aria-hidden="true"><div class="spinner"></div></div>
    <div id="notifications" class="space-y-2" aria-live="polite"></div>
    <nav class="bg-gray-800 bg-opacity-90 sticky top-0 z-50 p-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-green-500 flex items-center">
            <i class="fas fa-credit-card mr-2" aria-hidden="true"></i> LOGAN CC's
        </h1>
        <button id="themeToggle" class="text-gray-300 hover:text-green-500" aria-label="Alternar tema">
            <i class="fas fa-moon"></i>
        </button>
    </nav>
    <main class="container mx-auto p-6">
        <div class="form-container bg-gray-800 rounded-lg p-6">
            <h2 id="formTitle" class="text-xl font-semibold mb-4">Login</h2>
            <form id="authForm" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm">Usuário</label>
                    <input type="text" id="username" class="w-full p-2 bg-gray-700 border-b border-gray-600 rounded focus:ring-green-500 focus:border-green-500" aria-required="true" required>
                </div>
                <div>
                    <label for="password" class="block text-sm">Senha</label>
                    <input type="password" id="password" class="w-full p-2 bg-gray-700 border-b border-gray-600 rounded focus:ring-green-500 focus:border-green-500" aria-required="true" required>
                </div>
                <button type="submit" class="w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600" id="submitButton">Entrar</button>
                <p class="text-center text-sm">
                    <span id="toggleText">Não tem uma conta? </span>
                    <span class="form-toggle" onclick="toggleForm()">Cadastre-se</span>
                </p>
            </form>
        </div>
    </main>
    <div id="debug" aria-live="assertive"><div id="debug-output"></div></div>
    <script src="/debug.js"></script>
    <script src="/utils.js"></script>
    <script>
        let isLogin = true;

        function toggleForm() {
            isLogin = !isLogin;
            document.getElementById('formTitle').textContent = isLogin ? 'Login' : 'Cadastro';
            document.getElementById('submitButton').textContent = isLogin ? 'Entrar' : 'Cadastrar';
            document.getElementById('toggleText').textContent = isLogin ? 'Não tem uma conta? ' : 'Já tem uma conta? ';
            document.getElementById('authForm').reset();
            Debug.log(`Formulário alternado para: ${isLogin ? 'Login' : 'Cadastro'}`);
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const username = DOMPurify.sanitize(document.getElementById('username').value.trim());
            const password = document.getElementById('password').value;
            if (!username || !password) {
                showNotification('Por favor, preencha todos os campos.', true);
                Debug.error('Campos de usuário ou senha vazios');
                return;
            }
            const endpoint = isLogin ? '/api/login' : '/api/register';
            try {
                document.getElementById('globalLoader').style.visibility = 'visible';
                const response = await fetchWithTimeout(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                }, 5000);
                const data = await response.json();
                Debug.log(`Resposta ${endpoint}: Status ${response.status}`, data);
                document.getElementById('globalLoader').style.visibility = 'hidden';
                if (!response.ok) {
                    const errorMsg = data.error || 'Erro ao processar a solicitação. Tente novamente.';
                    showNotification(errorMsg, true);
                    Debug.error(`Erro na API: ${errorMsg}`);
                    return;
                }
                localStorage.setItem('userId', data.userId);
                showNotification(isLogin ? 'Login realizado com sucesso!' : 'Cadastro realizado com sucesso!', false);
                Debug.success(isLogin ? 'Login bem-sucedido' : 'Cadastro bem-sucedido', { userId: data.userId });
                setTimeout(() => { window.location.href = '/shop.html'; }, 1000);
            } catch (err) {
                document.getElementById('globalLoader').style.visibility = 'hidden';
                const errorMsg = err.message.includes('timeout') ? 'Tempo de conexão esgotado. Verifique sua rede.' : `Erro: ${err.message}. Tente novamente.`;
                showNotification(errorMsg, true);
                Debug.error(`Erro ao chamar ${endpoint}: ${err.message}`);
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('light');
            const isLight = document.body.classList.contains('light');
            document.getElementById('themeToggle').innerHTML = `<i class="fas fa-${isLight ? 'sun' : 'moon'}"></i>`;
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            Debug.log(`Tema alterado para: ${isLight ? 'claro' : 'escuro'}`);
        }

        document.addEventListener('DOMContentLoaded', () => {
            Debug.log('DOM carregado - index.html');
            document.getElementById('authForm').addEventListener('submit', handleSubmit);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
            document.getElementById('username').focus();
        });
    </script>
</body>
</html>
