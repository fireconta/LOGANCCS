<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - LoganCCS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/utils.js"></script>
  <script src="/debug.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #1a237e, #1565c0); }
    .card { transition: all 0.3s ease; }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
    .btn { transition: background-color 0.3s ease; }
    .btn:hover { background-color: #1e40af; }
  </style>
</head>
<body class="bg-gray-100">
  <nav class="gradient-bg text-white p-6 flex justify-between items-center shadow-lg">
    <h1 class="text-3xl font-bold">Dashboard</h1>
    <div class="flex items-center space-x-6">
      <span id="user-info" class="text-lg font-medium"></span>
      <a href="/index.html" class="hover:underline text-lg"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a>
    </div>
  </nav>
  <div class="container mx-auto p-6">
    <h2 class="text-3xl font-bold mb-8 text-gray-800">Painel de Administração</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Gerenciar Usuários -->
      <div class="bg-white p-6 rounded-xl shadow-lg card">
        <h3 class="text-xl font-bold mb-4 text-blue-900">Gerenciar Usuários</h3>
        <div id="users-container" class="space-y-4"></div>
      </div>
      <!-- Gerenciar Cartões -->
      <div class="bg-white p-6 rounded-xl shadow-lg card">
        <h3 class="text-xl font-bold mb-4 text-blue-900">Gerenciar Cartões</h3>
        <form id="add-card-form" class="mb-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Banco</label>
              <input id="card-bank" type="text" class="w-full p-3 border rounded-md" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Bandeira</label>
              <select id="card-brand" class="w-full p-3 border rounded-md" required>
                <option value="Visa">Visa</option>
                <option value="Mastercard">Mastercard</option>
                <option value="Elo">Elo</option>
                <option value="Amex">Amex</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nível</label>
              <select id="card-level" class="w-full p-3 border rounded-md" required>
                <option value="Classic">Classic</option>
                <option value="Gold">Gold</option>
                <option value="Platinum">Platinum</option>
                <option value="Business">Business</option>
                <option value="Black">Black</option>
                <option value="Infinite">Infinite</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Número (16 dígitos)</label>
              <input id="card-number" type="text" class="w-full p-3 border rounded-md" oninput="restrictInput(this, 'numeric', 16)" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">CVV</label>
              <input id="card-cvv" type="text" class="w-full p-3 border rounded-md" oninput="restrictInput(this, 'numeric', 4)" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Validade (MM/YYYY)</label>
              <input id="card-expiry" type="text" class="w-full p-3 border rounded-md" placeholder="MM/YYYY" required />
            </div>
          </div>
          <button type="submit" class="btn mt-4 w-full bg-blue-900 text-white p-3 rounded-md"><i class="fas fa-plus mr-2"></i>Adicionar Cartão</button>
        </form>
        <div id="cards-container" class="space-y-4"></div>
      </div>
      <!-- Gerenciar Preços -->
      <div class="bg-white p-6 rounded-xl shadow-lg card">
        <h3 class="text-xl font-bold mb-4 text-blue-900">Gerenciar Preços</h3>
        <div id="prices-container" class="space-y-4"></div>
      </div>
      <!-- Gerenciar Links de Pagamento -->
      <div class="bg-white p-6 rounded-xl shadow-lg card">
        <h3 class="text-xl font-bold mb-4 text-blue-900">Links de Pagamento</h3>
        <div id="payment-links-container" class="space-y-4"></div>
      </div>
    </div>
  </div>
  <script>
    debug.init('debug-panel', true);
    debug.log('Inicializando dashboard.html');

    async function checkAuth() {
      try {
        const response = await fetch('/.netlify/functions/app-function/check-auth', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const data = await response.json();
        if (!data.authenticated || !data.user.isAdmin) {
          window.location.href = '/index.html';
          return null;
        }
        document.getElementById('user-info').textContent = `Usuário: ${data.user.username} | Saldo: R$${data.user.balance.toFixed(2)}`;
        return data.user;
      } catch (error) {
        debug.error('Erro ao verificar autenticação: ' + error.message);
        window.location.href = '/index.html';
        return null;
      }
    }

    async function loadUsers() {
      try {
        const response = await fetch('/.netlify/functions/app-function/users', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const users = await response.json();
        const container = document.getElementById('users-container');
        container.innerHTML = '';
        users.forEach(user => {
          const userElement = document.createElement('div');
          userElement.className = 'p-4 bg-gray-100 rounded-md';
          userElement.innerHTML = DOMPurify.sanitize(`
            <p><strong>Usuário:</strong> ${user.username}</p>
            <p><strong>Saldo:</strong> R$${user.balance.toFixed(2)}</p>
            <p><strong>Admin:</strong> ${user.isAdmin ? 'Sim' : 'Não'}</p>
            <div class="mt-2 flex gap-2">
              <input type="number" step="0.01" id="balance-${user._id}" class="p-2 border rounded-md w-24" placeholder="Novo saldo" />
              <button onclick="updateUser('${user._id}', this.previousElementSibling.value, ${user.isAdmin})" class="btn px-3 py-1 bg-blue-900 text-white rounded-md"><i class="fas fa-edit"></i> Atualizar Saldo</button>
              <button onclick="updateUser('${user._id}', ${user.balance}, ${!user.isAdmin})" class="btn px-3 py-1 bg-blue-900 text-white rounded-md"><i class="fas fa-user-shield"></i> ${user.isAdmin ? 'Remover Admin' : 'Tornar Admin'}</button>
            </div>
          `);
          container.appendChild(userElement);
        });
        debug.log('Usuários carregados: ' + users.length);
      } catch (error) {
        debug.error('Erro ao carregar usuários: ' + error.message);
        alert('Erro ao carregar usuários. Tente novamente.');
      }
    }

    async function updateUser(userId, balance, isAdmin) {
      try {
        const response = await fetch('/.netlify/functions/app-function/users', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ userId, balance: balance ? parseFloat(balance) : undefined, isAdmin })
        });
        const data = await response.json();
        if (data.success) {
          alert('Usuário atualizado com sucesso!');
          loadUsers();
        } else {
          alert(data.error || 'Erro ao atualizar usuário');
        }
      } catch (error) {
        debug.error('Erro ao atualizar usuário: ' + error.message);
        alert('Erro ao atualizar usuário. Tente novamente.');
      }
    }

    async function loadCards() {
      try {
        const response = await fetch('/.netlify/functions/app-function/cards', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const cards = await response.json();
        const container = document.getElementById('cards-container');
        container.innerHTML = '';
        cards.forEach(card => {
          const cardElement = document.createElement('div');
          cardElement.className = 'p-4 bg-gray-100 rounded-md';
          cardElement.innerHTML = DOMPurify.sanitize(`
            <p><strong>Banco:</strong> ${card.bank}</p>
            <p><strong>Bandeira:</strong> ${card.brand}</p>
            <p><strong>Nível:</strong> ${card.level}</p>
            <p><strong>BIN:</strong> ${card.cardNumber.slice(0, 6)}</p>
            <button onclick="deleteCard('${card.cardNumber}')" class="btn mt-2 px-3 py-1 bg-red-600 text-white rounded-md"><i class="fas fa-trash"></i> Remover</button>
          `);
          container.appendChild(cardElement);
        });
        debug.log('Cartões carregados: ' + cards.length);
      } catch (error) {
        debug.error('Erro ao carregar cartões: ' + error.message);
        alert('Erro ao carregar cartões. Tente novamente.');
      }
    }

    async function deleteCard(cardNumber) {
      try {
        const response = await fetch('/.netlify/functions/app-function/cards', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ cardNumber })
        });
        const data = await response.json();
        if (data.success) {
          alert('Cartão removido com sucesso!');
          loadCards();
        } else {
          alert(data.error || 'Erro ao remover cartão');
        }
      } catch (error) {
        debug.error('Erro ao remover cartão: ' + error.message);
        alert('Erro ao remover cartão. Tente novamente.');
      }
    }

    async function addCard(event) {
      event.preventDefault();
      const bank = document.getElementById('card-bank').value;
      const brand = document.getElementById('card-brand').value;
      const level = document.getElementById('card-level').value;
      const cardNumber = document.getElementById('card-number').value;
      const cvv = document.getElementById('card-cvv').value;
      const expiry = document.getElementById('card-expiry').value;
      const [expiryMonth, expiryYear] = expiry.split('/');

      if (!bank || !brand || !level || !cardNumber || !cvv || !expiryMonth || !expiryYear || cardNumber.length !== 16 || cvv.length < 3 || cvv.length > 4 || isNaN(expiryMonth) || isNaN(expiryYear)) {
        alert('Preencha todos os campos corretamente.');
        return;
      }

      try {
        const response = await fetch('/.netlify/functions/app-function/cards', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ bank, brand, level, cardNumber, cvv, expiryMonth, expiryYear })
        });
        const data = await response.json();
        if (data.success) {
          alert('Cartão adicionado com sucesso!');
          document.getElementById('add-card-form').reset();
          loadCards();
        } else {
          alert(data.error || 'Erro ao adicionar cartão');
        }
      } catch (error) {
        debug.error('Erro ao adicionar cartão: ' + error.message);
        alert('Erro ao adicionar cartão. Tente novamente.');
      }
    }

    async function loadPrices() {
      try {
        const response = await fetch('/.netlify/functions/app-function/cardprices', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const prices = await response.json();
        const container = document.getElementById('prices-container');
        container.innerHTML = '';
        prices.forEach(price => {
          const priceElement = document.createElement('div');
          priceElement.className = 'p-4 bg-gray-100 rounded-md';
          priceElement.innerHTML = DOMPurify.sanitize(`
            <p><strong>Nível:</strong> ${price.nivel}</p>
            <p><strong>Preço:</strong> R$${price.price.toFixed(2)}</p>
            <div class="mt-2 flex gap-2">
              <input type="number" step="0.01" id="price-${price.nivel}" class="p-2 border rounded-md w-24" placeholder="Novo preço" />
              <button onclick="updatePrice('${price.nivel}', this.previousElementSibling.value)" class="btn px-3 py-1 bg-blue-900 text-white rounded-md"><i class="fas fa-edit"></i> Atualizar</button>
            </div>
          `);
          container.appendChild(priceElement);
        });
        debug.log('Preços carregados: ' + prices.length);
      } catch (error) {
        debug.error('Erro ao carregar preços: ' + error.message);
        alert('Erro ao carregar preços. Tente novamente.');
      }
    }

    async function updatePrice(nivel, price) {
      if (!price || price <= 0) {
        alert('Preço inválido');
        return;
      }
      try {
        const response = await fetch('/.netlify/functions/app-function/cardprices', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ nivel, price: parseFloat(price) })
        });
        const data = await response.json();
        if (data.success) {
          alert('Preço atualizado com sucesso!');
          loadPrices();
        } else {
          alert(data.error || 'Erro ao atualizar preço');
        }
      } catch (error) {
        debug.error('Erro ao atualizar preço: ' + error.message);
        alert('Erro ao atualizar preço. Tente novamente.');
      }
    }

    async function loadPaymentLinks() {
      try {
        const response = await fetch('/.netlify/functions/app-function/cardprices', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        });
        const prices = await response.json();
        const container = document.getElementById('payment-links-container');
        container.innerHTML = '';
        prices.forEach(price => {
          const linkElement = document.createElement('div');
          linkElement.className = 'p-4 bg-gray-100 rounded-md';
          linkElement.innerHTML = DOMPurify.sanitize(`
            <p><strong>Nível:</strong> ${price.nivel}</p>
            <p><strong>Link:</strong> <a href="${price.paymentLink || '#'}" target="_blank">${price.paymentLink || 'Não definido'}</a></p>
            <div class="mt-2 flex gap-2">
              <input type="url" id="link-${price.nivel}" class="p-2 border rounded-md w-full" placeholder="Novo link" value="${price.paymentLink || ''}" />
              <button onclick="updatePaymentLink('${price.nivel}', this.previousElementSibling.value)" class="btn px-3 py-1 bg-blue-900 text-white rounded-md"><i class="fas fa-edit"></i> Atualizar</button>
            </div>
          `);
          container.appendChild(linkElement);
        });
        debug.log('Links de pagamento carregados: ' + prices.length);
      } catch (error) {
        debug.error('Erro ao carregar links de pagamento: ' + error.message);
        alert('Erro ao carregar links de pagamento. Tente novamente.');
      }
    }

    async function updatePaymentLink(nivel, paymentLink) {
      try {
        const response = await fetch('/.netlify/functions/app-function/cardprices', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ nivel, paymentLink })
        });
        const data = await response.json();
        if (data.success) {
          alert('Link de pagamento atualizado com sucesso!');
          loadPaymentLinks();
        } else {
          alert(data.error || 'Erro ao atualizar link de pagamento');
        }
      } catch (error) {
        debug.error('Erro ao atualizar link de pagamento: ' + error.message);
        alert('Erro ao atualizar link de pagamento. Tente novamente.');
      }
    }

    async function init() {
      const user = await checkAuth();
      if (!user) return;
      await Promise.all([loadUsers(), loadCards(), loadPrices(), loadPaymentLinks()]);
      document.getElementById('add-card-form').addEventListener('submit', addCard);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
