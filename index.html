<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGAN CC's - Login</title>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: opacity 0.5s ease, transform 0.3s ease;
            opacity: 1;
            min-width: 200px;
            max-width: 400px;
            z-index: 10000;
            transform: translateY(0);
        }
        .notification.bg-red-600 { background-color: #dc2626; }
        .notification.bg-green-600 { background-color: #16a34a; }
        .notification.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }
        #logModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            overflow: auto;
        }
        #logModal .modal-content {
            background: #1f2937;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
        }
        #logContent {
            max-height: 400px;
            overflow-y: auto;
            background: #111827;
            padding: 1rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: #d1d5db;
        }
        #logContent .log { color: #d1d5db; }
        #logContent .error { color: #f87171; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">
    <!-- Div para notificações -->
    <div id="notifications" class="fixed top-4 right-4 space-y-2 z-50"></div>

    <!-- Botão LOG -->
    <button id="logButton" class="fixed top-4 left-4 p-2 bg-blue-500 hover:bg-blue-600 rounded-md font-semibold transition duration-200">LOG</button>

    <!-- Modal de Logs -->
    <div id="logModal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Logs do Sistema</h2>
            <div id="logContent"></div>
            <button id="closeLogModal" class="mt-4 p-2 bg-red-500 hover:bg-red-600 rounded-md font-semibold transition duration-200">Fechar</button>
        </div>
    </div>

    <!-- Formulário de Login -->
    <div id="loginContainer" class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md">
        <h2 class="text-2xl font-bold mb-6 text-center">Login - LOGAN CC's</h2>
        <div class="space-y-4">
            <input id="username" type="text" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Usuário" autocomplete="username">
            <input id="password" type="password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Senha" autocomplete="current-password">
            <button id="loginButton" class="w-full p-3 bg-green-500 hover:bg-green-600 rounded-md font-semibold transition duration-200">Entrar</button>
            <div id="loginError" class="text-red-500 text-sm mt-2 text-center hidden"></div>
            <p class="text-center mt-4">Não tem conta? <a id="toggleRegister" class="text-green-500 hover:underline cursor-pointer">Registre-se</a></p>
        </div>
    </div>

    <!-- Formulário de Registro -->
    <div id="registerContainer" class="bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md hidden">
        <h2 class="text-2xl font-bold mb-6 text-center">Registro - LOGAN CC's</h2>
        <div class="space-y-4">
            <input id="newUsername" type="text" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Usuário" autocomplete="username">
            <input id="newPassword" type="password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Senha" autocomplete="new-password">
            <input id="confirmPassword" type="password" class="w-full p-3 bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Confirmar Senha" autocomplete="new-password">
            <button id="registerButton" class="w-full p-3 bg-green-500 hover:bg-green-600 rounded-md font-semibold transition duration-200">Registrar</button>
            <div id="registerError" class="text-red-500 text-sm mt-2 text-center hidden"></div>
            <p class="text-center mt-4">Já tem conta? <a id="toggleLogin" class="text-green-500 hover:underline cursor-pointer">Faça login</a></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>
    <!-- Configurações Globais -->
    <script src="script.js"></script>
    <!-- Lógica da Página -->
    <script>
        // Verificar dependências
        if (!window.addLog) {
            console.error('Erro: window.addLog não definido. Verifique se script.js foi carregado.');
        }

        // Inicializar Firebase
        try {
            firebase.initializeApp(window.firebaseConfig);
            window.db = firebase.firestore();
            window.addLog('Firebase inicializado com sucesso.');
        } catch (err) {
            console.error(`Erro ao inicializar Firebase: ${err.message}`);
            window.addLog && window.addLog(`Erro ao inicializar Firebase: ${err.message}`, 'error');
        }

        // Definir UI
        const ui = {
            showNotification(message, type = 'error') {
                window.addLog(`Notificação: ${message} (${type})`);
                const notificationsDiv = document.getElementById('notifications');
                if (!notificationsDiv) {
                    window.addLog('Div #notifications não encontrado', 'error');
                    return;
                }
                const notification = document.createElement('div');
                notification.className = `notification ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
                notification.textContent = message;
                notificationsDiv.appendChild(notification);
                setTimeout(() => {
                    notification.classList.add('fade-out');
                    setTimeout(() => notification.remove(), 500);
                }, window.CONFIG.NOTIFICATION_DURATION_MS);
            },

            showError(context, message) {
                window.addLog(`Erro em ${context}: ${message}`, 'error');
                this.showNotification(message, 'error');
                const errorElement = document.getElementById(`${context}Error`);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.classList.remove('hidden');
                }
            },

            showSuccess(message) {
                window.addLog(`Sucesso: ${message}`);
                this.showNotification(message, 'success');
            },

            toggleLoading(buttonId, isLoading) {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = isLoading;
                    button.innerHTML = isLoading ? 'Carregando...' : (buttonId === 'loginButton' ? 'Entrar' : 'Registrar');
                }
            },

            toggleForms() {
                window.addLog('Alternando formulários');
                const loginContainer = document.getElementById('loginContainer');
                const registerContainer = document.getElementById('registerContainer');
                if (loginContainer && registerContainer) {
                    loginContainer.classList.toggle('hidden');
                    registerContainer.classList.toggle('hidden');
                    document.getElementById('loginError')?.classList.add('hidden');
                    document.getElementById('registerError')?.classList.add('hidden');
                } else {
                    window.addLog('Contêineres de login ou registro não encontrados', 'error');
                }
            },

            updateLogModal() {
                const logContent = document.getElementById('logContent');
                if (logContent) {
                    logContent.innerHTML = window.state.logs
                        .map(log => `<div class="${log.type}">${log.timestamp} - ${log.message}</div>`)
                        .join('');
                    logContent.scrollTop = logContent.scrollHeight;
                } else {
                    window.addLog('Elemento logContent não encontrado', 'error');
                }
            },

            showLogModal() {
                const logModal = document.getElementById('logModal');
                if (logModal) {
                    this.updateLogModal();
                    logModal.style.display = 'block';
                    window.addLog('Modal de logs aberto');
                } else {
                    window.addLog('Modal de logs não encontrado', 'error');
                }
            },

            hideLogModal() {
                const logModal = document.getElementById('logModal');
                if (logModal) {
                    logModal.style.display = 'none';
                    window.addLog('Modal de logs fechado');
                }
            }
        };

        // Definir autenticação
        const auth = {
            async login(username, password) {
                window.addLog(`Tentando login: ${username}`);
                if (!window.utils.debounce()) {
                    ui.showError('login', 'Aguarde antes de tentar novamente.');
                    return;
                }
                if (!window.db) {
                    ui.showError('login', 'Erro de conexão com o banco de dados.');
                    window.addLog('window.db não inicializado', 'error');
                    return;
                }
                username = window.utils.sanitizeInput(username);
                password = window.utils.sanitizeInput(password);
                if (!username || !password) {
                    ui.showError('login', 'Usuário e senha são obrigatórios.');
                    return;
                }
                ui.toggleLoading('loginButton', true);
                try {
                    const userDoc = await window.db.collection('users')
                        .where('username', '==', username)
                        .get();
                    window.addLog(`Consulta Firestore retornou ${userDoc.size} usuário(s)`);
                    if (userDoc.empty) {
                        ui.showError('login', 'Usuário não encontrado.');
                        return;
                    }
                    const user = userDoc.docs[0].data();
                    const userId = userDoc.docs[0].id;
                    window.addLog(`Usuário encontrado: ${JSON.stringify(user)}`);
                    if (user.password !== password) {
                        ui.showError('login', 'Senha incorreta.');
                        return;
                    }
                    window.state.currentUser = {
                        id: userId,
                        username: user.username,
                        balance: user.balance || 0,
                        is_admin: user.is_admin || false
                    };
                    localStorage.setItem('currentUser', JSON.stringify(window.state.currentUser));
                    localStorage.setItem('sessionStart', Date.now().toString());
                    ui.showSuccess(`Bem-vindo, ${username}!`);
                    window.addLog('Login bem-sucedido, redirecionando...');
                    setTimeout(() => {
                        window.location.href = 'shop.html';
                    }, 1000);
                } catch (err) {
                    window.addLog(`Erro no login: ${err.message}`, 'error');
                    ui.showError('login', 'Erro ao fazer login. Tente novamente.');
                } finally {
                    ui.toggleLoading('loginButton', false);
                }
            },

            async register(username, password, confirmPassword) {
                window.addLog(`Tentando registro: ${username}`);
                if (!window.utils.debounce()) {
                    ui.showError('register', 'Aguarde antes de tentar novamente.');
                    return;
                }
                if (!window.db) {
                    ui.showError('register', 'Erro de conexão com o banco de dados.');
                    window.addLog('window.db não inicializado', 'error');
                    return;
                }
                username = window.utils.sanitizeInput(username);
                password = window.utils.sanitizeInput(password);
                confirmPassword = window.utils.sanitizeInput(confirmPassword);
                if (!username || !password || !confirmPassword) {
                    ui.showError('register', 'Todos os campos são obrigatórios.');
                    return;
                }
                if (password !== confirmPassword) {
                    ui.showError('register', 'As senhas não coincidem.');
                    return;
                }
                if (username.length < 3 || !/^[a-zA-Z0-9]+$/.test(username)) {
                    ui.showError('register', 'Usuário deve ter pelo menos 3 caracteres alfanuméricos.');
                    return;
                }
                if (password.length < 6) {
                    ui.showError('register', 'Senha deve ter pelo menos 6 caracteres.');
                    return;
                }
                ui.toggleLoading('registerButton', true);
                try {
                    const userCheck = await window.db.collection('users')
                        .where('username', '==', username)
                        .get();
                    window.addLog(`Consulta Firestore retornou ${userCheck.size} usuário(s) existente(s)`);
                    if (!userCheck.empty) {
                        ui.showError('register', 'Este usuário já existe.');
                        return;
                    }
                    const docRef = await window.db.collection('users').add({
                        username,
                        password,
                        balance: 0,
                        is_admin: false,
                        created_at: new Date().toISOString()
                    });
                    window.addLog(`Usuário ${username} registrado com ID ${docRef.id}`);
                    ui.showSuccess('Conta criada com sucesso! Faça login.');
                    ui.toggleForms();
                } catch (err) {
                    window.addLog(`Erro no registro: ${err.message}`, 'error');
                    ui.showError('register', 'Erro ao registrar. Tente novamente.');
                } finally {
                    ui.toggleLoading('registerButton', false);
                }
            }
        };

        // Configurar eventos
        document.addEventListener('DOMContentLoaded', () => {
            window.addLog('DOM carregado');
            try {
                // Botão LOG
                const logButton = document.getElementById('logButton');
                const closeLogModal = document.getElementById('closeLogModal');
                if (logButton && closeLogModal) {
                    logButton.addEventListener('click', () => ui.showLogModal());
                    closeLogModal.addEventListener('click', () => ui.hideLogModal());
                    window.addEventListener('click', (event) => {
                        if (event.target === document.getElementById('logModal')) {
                            ui.hideLogModal();
                        }
                    });
                    window.addLog('Botão LOG configurado.');
                } else {
                    window.addLog('Botão LOG ou botão de fechar modal não encontrados', 'error');
                    ui.showNotification('Erro na configuração do modal.', 'error');
                }

                // Login
                const loginButton = document.getElementById('loginButton');
                if (loginButton) {
                    loginButton.addEventListener('click', () => {
                        window.addLog('Botão de login clicado');
                        auth.login(
                            document.getElementById('username').value.trim(),
                            document.getElementById('password').value.trim()
                        );
                    });
                    window.addLog('Botão de login configurado.');
                } else {
                    window.addLog('Botão de login não encontrado', 'error');
                    ui.showNotification('Botão de login não encontrado.', 'error');
                }

                // Registro
                const registerButton = document.getElementById('registerButton');
                if (registerButton) {
                    registerButton.addEventListener('click', () => {
                        window.addLog('Botão de registro clicado');
                        auth.register(
                            document.getElementById('newUsername').value.trim(),
                            document.getElementById('newPassword').value.trim(),
                            document.getElementById('confirmPassword').value.trim()
                        );
                    });
                    window.addLog('Botão de registro configurado.');
                } else {
                    window.addLog('Botão de registro não encontrado', 'error');
                    ui.showNotification('Botão de registro não encontrado.', 'error');
                }

                // Alternância de formulários
                const toggleRegister = document.getElementById('toggleRegister');
                const toggleLogin = document.getElementById('toggleLogin');
                if (toggleRegister && toggleLogin) {
                    toggleRegister.addEventListener('click', () => {
                        window.addLog('Alternando para registro');
                        ui.toggleForms();
                    });
                    toggleLogin.addEventListener('click', () => {
                        window.addLog('Alternando para login');
                        ui.toggleForms();
                    });
                    window.addLog('Links de alternância configurados.');
                } else {
                    window.addLog('Links de alternância não encontrados', 'error');
                    ui.showNotification('Erro na alternância de formulários.', 'error');
                }

                // Inicializar banco de dados
                if (window.db && window.utils && window.utils.initializeDatabase) {
                    window.utils.initializeDatabase(window.db, ui);
                    window.db.collection('users').get().then(() => {
                        window.addLog('Conexão com Firestore bem-sucedida.');
                        ui.showNotification('Conexão com Firestore OK!', 'success');
                    }).catch(err => {
                        window.addLog(`Erro ao conectar ao Firestore: ${err.message}`, 'error');
                        ui.showNotification('Erro na conexão com Firestore.', 'error');
                    });
                } else {
                    window.addLog('Erro: db ou utils não inicializados', 'error');
                    ui.showNotification('Erro ao inicializar o banco de dados.', 'error');
                }

                // Notificação inicial
                ui.showNotification('Sistema inicializado!', 'success');
            } catch (err) {
                window.addLog(`Erro ao configurar eventos: ${err.message}`, 'error');
                ui.showNotification('Erro ao inicializar a interface.', 'error');
            }
        });
    </script>
</body>
</html>
